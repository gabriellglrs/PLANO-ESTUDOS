<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plano de Estudos ‚Äî TEC Concursos</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#05070f;--surface:#0b0e1a;--surface2:#111523;--surface3:#181d2e;--surface4:#1e2438;
  --border:#1a2035;--border2:#212840;--border3:#2a3350;
  --accent:#5b8af7;--accent-dim:#3d65d4;
  --green:#3ddba0;--green-dim:#28a877;
  --orange:#f5824a;--orange-dim:#c45e30;
  --yellow:#f0c040;--yellow-dim:#c49a28;
  --purple:#a06cf0;--purple-dim:#7848c8;
  --cyan:#30c8e8;
  --text:#e2e8f8;--text2:#b0bcd8;--muted:#5e6e90;--muted2:#3a4560;
  --red:#f05060;
  --font:'Inter',sans-serif;--mono:'JetBrains Mono',monospace;
  --r-sm:8px;--r-md:12px;--r-lg:16px;--r-xl:20px;
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:var(--font);min-height:100vh;overflow-x:hidden;font-size:14px;line-height:1.5;-webkit-font-smoothing:antialiased}

/* NOISE TEXTURE + GRADIENT BG */
body::before{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background:
    radial-gradient(ellipse 80% 60% at 10% -5%, rgba(91,138,247,.09) 0%, transparent 55%),
    radial-gradient(ellipse 60% 50% at 95% 100%, rgba(61,219,160,.06) 0%, transparent 55%),
    radial-gradient(ellipse 40% 30% at 50% 50%, rgba(160,108,240,.04) 0%, transparent 70%)}
body::after{content:'';position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.4;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='.04'/%3E%3C/svg%3E")}

.container{position:relative;z-index:1;max-width:1240px;margin:0 auto;padding:52px 28px 120px}

/* ‚îÄ‚îÄ STICKY NAV ‚îÄ‚îÄ */
.sticky-nav{position:fixed;top:0;left:0;right:0;z-index:100;
  background:rgba(5,7,15,.88);backdrop-filter:blur(20px) saturate(1.4);
  border-bottom:1px solid var(--border2);transform:translateY(-100%);transition:transform .3s cubic-bezier(.4,0,.2,1)}
.sticky-nav.visible{transform:translateY(0)}
.sticky-nav-inner{max-width:1240px;margin:0 auto;padding:10px 28px;display:flex;justify-content:space-between;align-items:center;gap:16px}
.sticky-nav .tabs{background:transparent;border:none;padding:0;gap:4px}
.sticky-nav .tab{padding:6px 14px;font-size:11px;border-radius:7px}
.sticky-nav-title{font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.08em;text-transform:uppercase}
.save-ok-sticky{font-size:11px;color:var(--green);opacity:0;transition:opacity .3s;display:flex;align-items:center;gap:5px;font-weight:600}
.save-ok-sticky.show{opacity:1}

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tabs-wrap{display:flex;justify-content:space-between;align-items:center;margin-bottom:36px;flex-wrap:wrap;gap:12px}
.tabs{display:flex;gap:3px;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r-md);padding:4px}
.tab{padding:8px 18px;border-radius:9px;font-family:var(--font);font-size:12px;font-weight:600;letter-spacing:.02em;cursor:pointer;color:var(--muted);border:none;background:transparent;transition:all .2s;white-space:nowrap}
.tab.active{background:var(--surface4);color:var(--text);box-shadow:0 1px 0 var(--border3),0 4px 12px rgba(0,0,0,.4)}
.tab:not(.active):hover{color:var(--text2);background:rgba(255,255,255,.03)}
.tab-badge{display:inline-flex;align-items:center;justify-content:center;min-width:17px;height:17px;border-radius:9px;background:var(--orange);color:#fff;font-size:9px;font-weight:800;padding:0 4px;margin-left:6px;vertical-align:middle}
.tab-content{display:none}.tab-content.active{display:block}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header-tag{font-size:10px;letter-spacing:.22em;color:var(--accent);text-transform:uppercase;margin-bottom:12px;display:flex;align-items:center;gap:10px;font-weight:600}
.header-tag::before{content:'';display:inline-block;width:28px;height:1px;background:linear-gradient(90deg,var(--accent),transparent)}
h1{font-family:var(--font);font-size:clamp(2rem,4.5vw,3.2rem);font-weight:900;line-height:1.05;letter-spacing:-.04em;
  background:linear-gradient(135deg,#e2e8f8 0%,#5b8af7 45%,#3ddba0 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:10px}
.header-meta{color:var(--muted);font-size:12px;line-height:2}
.header-meta .hl{color:var(--green);font-weight:600}
.save-ok{font-size:11px;color:var(--green);opacity:0;transition:opacity .3s;display:flex;align-items:center;gap:5px;font-weight:600}
.save-ok.show{opacity:1}

/* ‚îÄ‚îÄ PANEL ‚îÄ‚îÄ */
.panel{background:var(--surface);border:1px solid var(--border2);border-radius:var(--r-xl);padding:28px;margin-bottom:24px;animation:fadeUp .45s ease both;position:relative;overflow:hidden}
.panel::before{content:'';position:absolute;inset:0;border-radius:var(--r-xl);background:linear-gradient(135deg,rgba(255,255,255,.015) 0%,transparent 60%);pointer-events:none}
.panel-title{font-size:11px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;margin-bottom:20px;display:flex;align-items:center;gap:8px;color:var(--muted)}
.panel-title .icon{font-size:14px}

/* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
.config-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(185px,1fr));gap:18px;margin-bottom:22px}
.field{display:flex;flex-direction:column;gap:7px}
.field label{font-size:10px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);font-weight:600}
.field input[type=date],.field select,.field input[type=number]{
  background:var(--surface3);border:1px solid var(--border3);border-radius:var(--r-sm);color:var(--text);
  font-family:var(--mono);font-size:12px;padding:10px 14px;outline:none;cursor:pointer;
  transition:border-color .2s,box-shadow .2s;width:100%;-webkit-appearance:none}
.field input:focus,.field select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(91,138,247,.12)}
input[type=range]{-webkit-appearance:none;height:3px;border-radius:2px;background:var(--border3);outline:none;width:100%;cursor:pointer}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);cursor:pointer;box-shadow:0 0 0 4px rgba(91,138,247,.15),0 2px 6px rgba(0,0,0,.4)}
.range-label{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px}
.range-big{font-family:var(--font);font-size:22px;font-weight:800;color:var(--text)}
.range-unit{font-size:10px;color:var(--muted)}

/* ‚îÄ‚îÄ DAY HOURS ‚îÄ‚îÄ */
.day-hours-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-bottom:22px}
.dh{background:var(--surface3);border:1px solid var(--border2);border-radius:var(--r-md);padding:14px 10px;text-align:center;transition:all .2s}
.dh.active-day{border-color:rgba(91,138,247,.35);background:rgba(91,138,247,.04)}
.dh-name{font-size:11px;font-weight:700;color:var(--muted);margin-bottom:10px;letter-spacing:.05em;text-transform:uppercase}
.dh-val{font-family:var(--font);font-size:18px;font-weight:800;color:var(--green);margin:6px 0 3px}
.dh-sub{font-size:9px;color:var(--muted);font-family:var(--mono)}
.dh-toggle{font-size:9px;color:var(--muted2);cursor:pointer;margin-top:9px;display:block;border:1px solid var(--border3);border-radius:5px;padding:3px 6px;background:transparent;font-family:var(--mono);width:100%;transition:all .2s;letter-spacing:.03em}
.dh-toggle:hover{color:var(--orange);border-color:rgba(245,130,74,.35)}
.dh.folga{opacity:.45}
.dh.folga .dh-val{color:var(--muted2)}

/* ‚îÄ‚îÄ BTN ‚îÄ‚îÄ */
.btn-row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.btn{display:inline-flex;align-items:center;gap:8px;font-family:var(--font);font-weight:700;font-size:12px;letter-spacing:.03em;padding:11px 22px;border-radius:var(--r-sm);border:none;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.btn::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.08) 0%,transparent 100%);pointer-events:none}
.btn-primary{background:linear-gradient(135deg,var(--accent) 0%,var(--accent-dim) 100%);color:#fff;box-shadow:0 4px 14px rgba(91,138,247,.3)}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(91,138,247,.4)}
.btn-ghost{background:transparent;color:var(--orange);border:1px solid rgba(245,130,74,.3)}
.btn-ghost:hover{background:rgba(245,130,74,.07);border-color:rgba(245,130,74,.5)}
.btn-green{background:linear-gradient(135deg,var(--green) 0%,var(--green-dim) 100%);color:#05070f;font-weight:800;box-shadow:0 4px 14px rgba(61,219,160,.25)}
.btn-green:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(61,219,160,.35)}
.btn-sm{padding:7px 14px;font-size:11px}

/* ‚îÄ‚îÄ PILLS ‚îÄ‚îÄ */
.pills{display:flex;flex-wrap:wrap;gap:8px;margin-top:16px}
.pill{font-size:11px;padding:5px 13px;border-radius:20px;border:1px solid var(--border3);color:var(--muted);background:var(--surface3);font-family:var(--mono)}
.pill b{color:var(--text);font-weight:600}

/* ‚îÄ‚îÄ PROGRESS OVERVIEW ‚îÄ‚îÄ */
.mat-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(248px,1fr));gap:14px;margin-bottom:30px}
.mat-card{background:var(--surface2);border:1px solid var(--border2);border-radius:var(--r-lg);padding:18px;transition:all .2s;position:relative;overflow:hidden}
.mat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;border-radius:var(--r-lg) var(--r-lg) 0 0;background:var(--card-accent,var(--accent));opacity:.6}
.mat-card:hover{border-color:var(--border3);transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,0,0,.3)}
.mat-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.mat-name{font-size:13px;font-weight:800;letter-spacing:-.01em}
.volta-chip{font-size:9px;padding:2px 9px;border-radius:10px;background:rgba(160,108,240,.1);border:1px solid rgba(160,108,240,.25);color:var(--purple);white-space:nowrap;font-weight:600;font-family:var(--mono)}
.mini-bar{width:100%;height:3px;background:var(--border3);border-radius:2px;overflow:hidden;margin:9px 0}
.mini-fill{height:100%;border-radius:2px;transition:width .8s ease}
.mat-meta{display:flex;justify-content:space-between;font-size:10px;color:var(--muted);font-family:var(--mono)}
.mat-stats-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-top:12px}
.mat-stat{background:rgba(255,255,255,.025);border:1px solid var(--border2);border-radius:var(--r-sm);padding:8px;text-align:center}
.mat-stat-val{font-size:14px;font-weight:800;line-height:1;color:var(--text)}
.mat-stat-lbl{font-size:9px;color:var(--muted);margin-top:3px;text-transform:uppercase;letter-spacing:.06em;font-family:var(--mono)}
.mat-acum-row{display:flex;align-items:center;gap:6px;margin-top:10px;padding:7px 9px;background:rgba(240,192,64,.05);border:1px solid rgba(240,192,64,.15);border-radius:var(--r-sm)}
.mat-next-topic{margin-top:9px;padding:7px 10px;background:rgba(91,138,247,.05);border:1px solid rgba(91,138,247,.14);border-radius:var(--r-sm);font-size:10px;color:var(--muted)}
.mat-next-topic b{color:var(--accent);font-weight:600}
.mat-erros-row{display:flex;align-items:center;gap:5px;margin-top:8px;font-size:10px;color:var(--muted2)}

/* ‚îÄ‚îÄ LEGEND ‚îÄ‚îÄ */
.legend{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:28px}
.leg{display:flex;align-items:center;gap:7px;background:var(--surface2);border:1px solid var(--border2);border-radius:var(--r-sm);padding:5px 12px;font-size:11px;font-weight:500}
.leg-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}

/* ‚îÄ‚îÄ SEMANA ACCORDION ‚îÄ‚îÄ */
.cycle-section{margin-bottom:20px}
.cycle-hdr{display:flex;align-items:center;margin-bottom:0;cursor:pointer;user-select:none;
  background:var(--surface2);border:1px solid var(--border2);border-radius:var(--r-md);padding:13px 18px;
  transition:all .2s}
.cycle-hdr:hover{background:var(--surface3);border-color:var(--border3)}
.cycle-hdr.open{border-radius:var(--r-md) var(--r-md) 0 0;border-bottom-color:transparent;background:var(--surface3)}
.cycle-hdr-left{display:flex;align-items:center;gap:14px;flex:1}
.cycle-badge{font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--green);
  background:rgba(61,219,160,.08);border:1px solid rgba(61,219,160,.2);border-radius:5px;padding:4px 11px;white-space:nowrap}
.cycle-dates{font-size:11px;color:var(--muted);font-family:var(--mono)}
.cycle-arrow{font-size:13px;color:var(--muted2);transition:transform .25s;margin-left:8px}
.cycle-hdr.open .cycle-arrow{transform:rotate(90deg)}
.cycle-stats-mini{display:flex;gap:12px;align-items:center;flex-shrink:0}
.csm-item{font-size:10px;color:var(--muted);white-space:nowrap;font-family:var(--mono)}
.csm-item b{color:var(--green);font-weight:600}
.cycle-body{display:none;border:1px solid var(--border2);border-top:none;border-radius:0 0 var(--r-md) var(--r-md);overflow:hidden}
.cycle-body.open{display:block}
.days-grid{display:flex;flex-direction:column;gap:0}

/* ‚îÄ‚îÄ DAY CARD ACCORDION ‚îÄ‚îÄ */
.day-card{background:var(--surface);border-bottom:1px solid var(--border2);overflow:hidden;transition:background .2s}
.day-card:last-child{border-bottom:none;border-radius:0 0 var(--r-md) var(--r-md)}
.day-card.folga-card{opacity:.5}
.day-card.done-card .day-body{opacity:.5}
.day-card.today-card{background:rgba(61,219,160,.018);border-left:2px solid rgba(61,219,160,.3)}

.day-hdr-row{display:flex;align-items:center;cursor:pointer;padding:0;user-select:none;transition:background .2s}
.day-hdr-row:hover{background:rgba(255,255,255,.015)}
.day-info{padding:14px 20px;min-width:195px;border-right:1px solid var(--border2);flex-shrink:0}
.day-name{font-size:14px;font-weight:800;text-transform:capitalize;display:flex;align-items:center;gap:7px;letter-spacing:-.01em}
.today-chip-hdr{font-size:9px;padding:2px 8px;border-radius:8px;background:rgba(61,219,160,.14);border:1px solid rgba(61,219,160,.35);color:var(--green);font-family:var(--mono);font-weight:600}
.day-date-str{font-size:10px;color:var(--muted);margin-top:2px;font-family:var(--mono)}
.day-load{font-size:11px;color:var(--muted);margin-top:6px;display:flex;align-items:center;gap:6px;font-family:var(--mono)}
.day-load b{color:var(--yellow);font-size:13px;font-weight:800}
.day-load-rev{font-size:10px;color:var(--yellow);opacity:.7}

.day-reviews-col{padding:12px 16px;background:rgba(240,192,64,.014);border-right:1px solid var(--border2);flex:1;display:flex;flex-direction:column;justify-content:center;gap:5px;min-width:0}
.rev-label{font-size:10px;color:var(--yellow);letter-spacing:.07em;flex-shrink:0;margin-bottom:3px;font-weight:600}
.rev-chips{display:flex;flex-wrap:wrap;gap:5px;align-items:center}
.rev-chip{font-size:10px;padding:2px 9px;border-radius:12px;white-space:nowrap;cursor:default;font-family:var(--mono)}
.rev-chip.normal{border:1px solid rgba(240,192,64,.2);color:var(--yellow);background:rgba(240,192,64,.05)}
.rev-chip.today-chip{border:1px solid rgba(61,219,160,.35);color:var(--green);background:rgba(61,219,160,.07)}
.rev-chip.overdue-chip{border:1px solid rgba(240,80,96,.35);color:var(--red);background:rgba(240,80,96,.06)}
.rev-empty{font-size:10px;color:var(--muted2);font-family:var(--mono)}

.day-arrow-col{padding:0 18px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.day-arrow{font-size:13px;color:var(--muted2);transition:transform .25s}
.day-hdr-row.open .day-arrow{transform:rotate(90deg)}

/* ‚îÄ‚îÄ DAY BODY ‚îÄ‚îÄ */
.day-body{display:grid;grid-template-columns:1fr 1fr;border-top:1px solid var(--border2)}
.session{padding:20px 22px}
.session+.session{border-left:1px solid var(--border2)}
.sess-label{font-size:10px;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:14px;display:flex;align-items:center;gap:7px;font-weight:700}
.sess-label::before{content:'';width:6px;height:6px;border-radius:50%;background:currentColor;display:inline-block;flex-shrink:0;box-shadow:0 0 8px currentColor}
.session.manha .sess-label{color:var(--accent)}
.session.noite .sess-label{color:var(--purple)}

/* ‚îÄ‚îÄ SESSION MAT HEADER ‚îÄ‚îÄ */
.sess-mat{font-size:16px;font-weight:800;display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:14px;color:var(--text);letter-spacing:-.02em}
.mbadge{font-family:var(--mono);font-size:10px;padding:3px 8px;border-radius:5px;border:1px solid;font-weight:600;letter-spacing:.03em}
.badge-ti{background:rgba(91,138,247,.12);border-color:rgba(91,138,247,.3);color:var(--accent)}
.badge-pt{background:rgba(245,130,74,.12);border-color:rgba(245,130,74,.3);color:var(--orange)}
.badge-mt{background:rgba(61,219,160,.12);border-color:rgba(61,219,160,.3);color:var(--green)}
.badge-prob{background:rgba(160,108,240,.12);border-color:rgba(160,108,240,.3);color:var(--purple)}
.badge-en{background:rgba(240,192,64,.12);border-color:rgba(240,192,64,.3);color:var(--yellow)}
.badge-bc{background:rgba(245,130,74,.12);border-color:rgba(245,130,74,.3);color:var(--orange)}
.badge-at{background:rgba(48,200,232,.12);border-color:rgba(48,200,232,.3);color:var(--cyan)}
.badge-red{background:rgba(240,192,64,.12);border-color:rgba(240,192,64,.3);color:var(--yellow)}
.restart-banner{display:flex;align-items:center;gap:8px;font-size:11px;padding:9px 13px;background:rgba(160,108,240,.07);border:1px solid rgba(160,108,240,.2);border-radius:var(--r-sm);color:var(--purple);margin-bottom:13px;font-weight:500}


/* ‚îÄ‚îÄ T√ìPICOS ‚îÄ‚îÄ */
.topics{list-style:none;display:flex;flex-direction:column;gap:8px}
.topic-item{background:var(--surface3);border:1px solid var(--border2);border-radius:var(--r-sm);padding:11px 14px;transition:border-color .2s}
.topic-item:hover{border-color:var(--border3)}
.topic-top{display:flex;align-items:center;justify-content:space-between;gap:10px}
.topic-name{font-size:12px;font-weight:600;color:var(--text);flex:1;min-width:0;letter-spacing:-.01em}
.size-tag{font-size:9px;padding:2px 7px;border-radius:4px;font-family:var(--mono);font-weight:600;white-space:nowrap;flex-shrink:0}
.size-g{background:rgba(61,219,160,.1);border:1px solid rgba(61,219,160,.2);color:var(--green)}
.size-m{background:rgba(91,138,247,.1);border:1px solid rgba(91,138,247,.2);color:var(--accent)}
.size-p{background:rgba(160,108,240,.1);border:1px solid rgba(160,108,240,.2);color:var(--purple)}
.topic-meta{display:flex;align-items:center;gap:8px;margin-top:7px;font-size:10px;color:var(--muted);font-family:var(--mono);flex-wrap:wrap}
.t-qs{color:var(--text);font-weight:600}
.t-total{color:var(--muted)}
.t-time{color:var(--muted)}
.topic-bar{height:2px;background:var(--border2);border-radius:1px;overflow:hidden;margin-top:8px}
.topic-fill{height:100%;border-radius:1px;background:linear-gradient(90deg,var(--accent),var(--green))}
.t-done{opacity:.55;background:rgba(61,219,160,.04);border-color:rgba(61,219,160,.15)}
.t-done .topic-name{text-decoration:line-through;color:var(--muted)}
.t-partial{border-color:rgba(240,192,64,.2)}

/* ‚îÄ‚îÄ HIER INDEX ‚îÄ‚îÄ */
.hier-wrap{margin-top:16px;border-radius:var(--r-md);overflow:hidden;border:1px solid var(--border2)}
.hier-toggle{width:100%;display:flex;justify-content:space-between;align-items:center;padding:11px 16px;background:var(--surface3);border:none;color:var(--text);cursor:pointer;font-family:var(--font);font-size:11px;transition:background .2s}
.hier-toggle:hover{background:var(--surface4)}
.ht-left{display:flex;align-items:center;gap:8px;font-weight:600;color:var(--muted)}
.ht-arrow{font-size:12px;color:var(--muted2);transition:transform .25s}
.hier-toggle.open .ht-arrow{transform:rotate(90deg)}
.hier-body{display:none;background:var(--surface2)}
.hier-body.open{display:block}
.hier-cat{border-top:1px solid var(--border2)}
.hier-cat-hdr{display:flex;align-items:center;gap:10px;padding:9px 16px;background:transparent;border:none;width:100%;cursor:pointer;transition:background .2s}
.hier-cat-hdr:hover{background:rgba(255,255,255,.02)}
.hc-arr{font-size:12px;color:var(--muted2);transition:transform .2s}
.hier-cat-hdr.open .hc-arr{transform:rotate(90deg)}
.hc-name{font-size:11px;font-weight:700;color:var(--text2);flex:1;text-align:left;letter-spacing:-.01em}
.hc-qty{font-size:10px;font-family:var(--mono);color:var(--green)}
.hier-cat-body{display:none;border-top:1px solid var(--border2)}
.hier-cat-body.open{display:block}
.hier-item{display:flex;align-items:center;gap:8px;padding:7px 14px;font-size:11px;border-bottom:1px solid rgba(255,255,255,.03);transition:background .15s;font-family:var(--mono)}
.hier-item:hover{background:rgba(255,255,255,.02)}
.hier-item:last-child{border-bottom:none}
.hi-code{font-size:10px;color:var(--muted);min-width:52px;flex-shrink:0;font-weight:500}
.hi-name{flex:1;color:var(--text2);font-family:var(--font);font-size:11px;font-weight:500}
.hi-sess-qs{font-size:9px;padding:2px 7px;border-radius:10px;background:rgba(91,138,247,.1);border:1px solid rgba(91,138,247,.25);color:var(--accent);font-weight:700;white-space:nowrap;flex-shrink:0;font-family:var(--mono)}
.hi-acum-qs{font-size:9px;padding:2px 7px;border-radius:10px;background:rgba(240,192,64,.08);border:1px solid rgba(240,192,64,.22);color:var(--yellow);font-weight:700;white-space:nowrap;flex-shrink:0;font-family:var(--mono)}
.hi-qty{font-size:10px;color:var(--muted2);white-space:nowrap;flex-shrink:0}

/* ‚îÄ‚îÄ DAY FOOTER ‚îÄ‚îÄ */
.day-footer{padding:14px 22px;border-top:1px solid var(--border2);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;background:rgba(255,255,255,.01);grid-column:1/-1}
.btn-concluir{font-family:var(--font);font-size:11px;font-weight:700;padding:8px 18px;border-radius:var(--r-sm);border:1px solid rgba(61,219,160,.35);color:var(--green);background:rgba(61,219,160,.07);cursor:pointer;transition:all .2s;letter-spacing:.02em}
.btn-concluir:hover{background:rgba(61,219,160,.15);border-color:rgba(61,219,160,.55);transform:translateY(-1px)}
.btn-desfazer{font-size:10px;color:var(--muted2);background:transparent;border:1px solid var(--border3);border-radius:var(--r-sm);padding:5px 11px;cursor:pointer;font-family:var(--mono);transition:all .2s}
.btn-desfazer:hover{color:var(--orange);border-color:rgba(245,130,74,.3)}
.day-qs-info{font-size:10px;color:var(--muted);font-family:var(--mono)}
.day-qs-info b{color:var(--green);font-weight:700}
.done-banner{font-size:11px;color:var(--green);font-weight:700;display:flex;align-items:center;gap:7px}

/* ‚îÄ‚îÄ CYCLE FOOTER ‚îÄ‚îÄ */
.cycle-footer{padding:16px 22px;background:rgba(61,219,160,.02);border-top:1px solid rgba(61,219,160,.08);display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:14px}
.stat-item{text-align:center}
.stat-val{font-size:22px;font-weight:900;color:var(--green);line-height:1;letter-spacing:-.03em}
.stat-lbl{font-size:9px;color:var(--muted);margin-top:4px;text-transform:uppercase;letter-spacing:.08em;font-family:var(--mono)}

/* ‚îÄ‚îÄ NOTE ‚îÄ‚îÄ */
.note{margin-top:28px;padding:16px 20px;background:rgba(91,138,247,.05);border-left:3px solid var(--accent);border-radius:0 var(--r-sm) var(--r-sm) 0;font-size:12px;color:var(--muted);line-height:2}
.note b{color:var(--text);font-weight:600}

/* ‚îÄ‚îÄ AC√öMULO BADGE ‚îÄ‚îÄ */
.acum-badge{display:inline-flex;align-items:center;gap:4px;font-size:9px;padding:2px 7px;border-radius:8px;background:rgba(240,192,64,.09);border:1px solid rgba(240,192,64,.23);color:var(--yellow);margin-left:7px;font-family:var(--mono);font-weight:600}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CADERNO DE ERROS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.ce-top{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:14px;margin-bottom:22px}
.ce-stats{display:flex;gap:12px;flex-wrap:wrap}
.ce-stat{background:var(--surface3);border:1px solid var(--border2);border-radius:var(--r-md);padding:12px 18px;text-align:center}
.ce-stat-val{font-size:22px;font-weight:900;line-height:1;letter-spacing:-.03em}
.ce-stat-lbl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-top:4px;font-family:var(--mono)}

.add-error-panel{background:var(--surface3);border:1px solid var(--border2);border-radius:var(--r-lg);padding:22px;margin-bottom:22px}
.add-err-title{font-size:12px;font-weight:700;color:var(--green);margin-bottom:15px;letter-spacing:.06em;text-transform:uppercase}
.add-err-grid{display:grid;grid-template-columns:1fr 1fr 1fr auto auto;gap:12px;align-items:end}
.add-err-grid .field input[type=text]{
  background:var(--surface2);border:1px solid var(--border3);border-radius:var(--r-sm);color:var(--text);
  font-family:var(--mono);font-size:12px;padding:10px 14px;outline:none;width:100%;transition:border-color .2s,box-shadow .2s}
.add-err-grid .field input[type=text]:focus{border-color:var(--green);box-shadow:0 0 0 3px rgba(61,219,160,.1)}
.add-err-grid .field select,.add-err-grid .field input[type=date]{
  background:var(--surface2);border:1px solid var(--border3);border-radius:var(--r-sm);color:var(--text);
  font-family:var(--mono);font-size:12px;padding:10px 14px;outline:none;width:100%}

.tec-link{display:inline-flex;align-items:center;gap:6px;font-size:11px;color:var(--accent);border:1px solid rgba(91,138,247,.25);border-radius:var(--r-sm);padding:5px 13px;text-decoration:none;background:rgba(91,138,247,.06);transition:all .2s;font-weight:600}
.tec-link:hover{background:rgba(91,138,247,.14);border-color:rgba(91,138,247,.45)}
.tec-inline-link{display:inline-flex;align-items:center;gap:3px;margin-left:6px;font-size:10px;color:var(--accent);text-decoration:none;border:1px solid rgba(91,138,247,.3);border-radius:4px;padding:1px 6px;background:rgba(91,138,247,.07);font-family:var(--mono)}
.tec-inline-link:hover{background:rgba(91,138,247,.18)}

/* ‚îÄ‚îÄ REVIS√ÉO ESPA√áADA ‚îÄ‚îÄ */
.rev-presets{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.rev-preset-btn{font-family:var(--mono);font-size:10px;padding:5px 13px;border-radius:var(--r-sm);border:1px solid var(--border3);background:transparent;color:var(--muted);cursor:pointer;transition:all .2s;font-weight:500}
.rev-preset-btn.active{border-color:rgba(61,219,160,.4);color:var(--green);background:rgba(61,219,160,.07)}
.rev-preset-btn:hover{border-color:rgba(91,138,247,.3);color:var(--accent)}

/* ‚îÄ‚îÄ SUBMAT√âRIA SELECTOR ‚îÄ‚îÄ */
.sub-mat-select{display:none;margin-top:8px}
.sub-mat-select.visible{display:block}

/* ‚îÄ‚îÄ AGENDA ‚îÄ‚îÄ */
.agenda-section{margin-bottom:24px}
.agenda-title{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.12em;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.agenda-timeline{display:flex;flex-direction:column;gap:9px}
.agenda-day-row{display:grid;grid-template-columns:155px 1fr;gap:12px;align-items:center}
.agenda-date{font-size:11px;color:var(--muted);text-align:right;font-weight:600;font-family:var(--mono)}
.agenda-date.is-today{color:var(--green)}
.agenda-date.is-past{color:var(--red)}
.agenda-chips{display:flex;flex-wrap:wrap;gap:6px}
.agenda-chip{font-size:10px;padding:4px 11px;border-radius:9px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px;font-family:var(--mono);font-weight:500}
.agenda-chip.pending{border:1px solid rgba(240,192,64,.25);color:var(--yellow);background:rgba(240,192,64,.06)}
.agenda-chip.pending:hover{background:rgba(240,192,64,.12)}
.agenda-chip.done{border:1px solid rgba(61,219,160,.2);color:var(--green);background:rgba(61,219,160,.05);text-decoration:line-through;opacity:.6}
.agenda-chip.overdue{border:1px solid rgba(240,80,96,.3);color:var(--red);background:rgba(240,80,96,.06)}
.agenda-chip.overdue:hover{background:rgba(240,80,96,.12)}
.agenda-chip.today-chip{border:1px solid rgba(61,219,160,.35);color:var(--green);background:rgba(61,219,160,.07)}
.chip-mat{font-weight:700}
.chip-done-btn{font-size:9px;padding:1px 6px;border-radius:4px;background:rgba(61,219,160,.12);border:1px solid rgba(61,219,160,.2);color:var(--green);cursor:pointer;font-family:var(--mono)}

/* ‚îÄ‚îÄ ERRORS TABLE ‚îÄ‚îÄ */
.err-table-wrap{overflow-x:auto}
.err-table{width:100%;border-collapse:collapse;font-size:11px}
.err-table th{text-align:left;padding:9px 13px;color:var(--muted);font-size:10px;letter-spacing:.09em;text-transform:uppercase;border-bottom:1px solid var(--border2);font-family:var(--mono)}
.err-table td{padding:11px 13px;border-bottom:1px solid var(--border2);vertical-align:middle;color:var(--muted)}
.err-table td:first-child{color:var(--text);font-weight:600}
.err-table tr:last-child td{border-bottom:none}
.err-table tr:hover td{background:rgba(255,255,255,.015)}
.step-dots{display:flex;gap:5px;align-items:center;flex-wrap:wrap}
.step-dot{width:22px;height:22px;border-radius:50%;font-size:9px;display:flex;align-items:center;justify-content:center;font-weight:700;border:1px solid;cursor:pointer;transition:all .2s;font-family:var(--mono)}
.step-dot.done-dot{background:var(--green);border-color:var(--green);color:#05070f}
.step-dot.pending-dot{background:transparent;border-color:var(--border3);color:var(--muted)}
.step-dot.due-dot{background:rgba(240,192,64,.12);border-color:var(--yellow);color:var(--yellow)}
.step-dot.overdue-dot{background:rgba(240,80,96,.12);border-color:var(--red);color:var(--red)}
.err-del{background:transparent;border:none;color:var(--muted2);cursor:pointer;font-size:14px;padding:2px 4px;transition:color .2s}
.err-del:hover{color:var(--orange)}
.mat-tag{font-size:9px;padding:2px 7px;border-radius:4px;border:1px solid;font-family:var(--mono);font-weight:600}
.empty-ce{text-align:center;padding:48px;color:var(--muted2);font-size:13px}
.empty-ce .icon{font-size:34px;margin-bottom:12px}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:200;display:flex;align-items:center;justify-content:center;animation:fadeIn .2s ease;backdrop-filter:blur(4px)}
.modal-box{background:var(--surface2);border:1px solid var(--border3);border-radius:var(--r-xl);padding:32px;max-width:400px;width:90%;text-align:center;box-shadow:0 24px 60px rgba(0,0,0,.6)}
.modal-title{font-size:17px;font-weight:800;margin-bottom:10px;letter-spacing:-.02em}
.modal-text{font-size:12px;color:var(--muted);line-height:2;margin-bottom:24px}
.modal-actions{display:flex;gap:10px;justify-content:center}
.modal-cancel{padding:10px 24px;border-radius:var(--r-sm);border:1px solid var(--border3);background:transparent;color:var(--muted);font-family:var(--mono);font-size:12px;cursor:pointer;transition:all .2s}
.modal-cancel:hover{border-color:var(--border3);color:var(--text)}
.modal-confirm{padding:10px 24px;border-radius:var(--r-sm);border:none;background:var(--orange);color:#fff;font-family:var(--font);font-weight:700;font-size:12px;cursor:pointer;box-shadow:0 4px 12px rgba(245,130,74,.3)}

.section-divider{height:1px;background:linear-gradient(90deg,var(--border2),transparent);margin:28px 0}

/* ‚îÄ‚îÄ MODAL AJUDA ‚îÄ‚îÄ */
.ajuda-box{background:var(--surface2);border:1px solid var(--border3);border-radius:var(--r-xl);width:min(920px,96vw);max-height:88vh;display:flex;flex-direction:column;overflow:hidden;animation:slideUp .3s cubic-bezier(.4,0,.2,1);box-shadow:0 32px 80px rgba(0,0,0,.6)}
@keyframes slideUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
.ajuda-header{display:flex;justify-content:space-between;align-items:flex-start;padding:26px 30px 22px;border-bottom:1px solid var(--border2);flex-shrink:0}
.ajuda-super{font-size:10px;letter-spacing:.18em;text-transform:uppercase;color:var(--yellow);margin-bottom:5px;font-weight:700}
.ajuda-title{font-size:22px;font-weight:900;color:var(--text);letter-spacing:-.03em}
.ajuda-close{background:transparent;border:1px solid var(--border3);border-radius:var(--r-sm);color:var(--muted);font-size:14px;width:34px;height:34px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
.ajuda-close:hover{background:rgba(245,130,74,.1);color:var(--orange);border-color:rgba(245,130,74,.3)}
.ajuda-body{display:grid;grid-template-columns:210px 1fr;overflow:hidden;flex:1;min-height:0}
.ajuda-nav{border-right:1px solid var(--border2);padding:16px 12px;display:flex;flex-direction:column;gap:3px;overflow-y:auto;flex-shrink:0;background:rgba(255,255,255,.01)}
.ajuda-nav-item{background:transparent;border:none;color:var(--muted);font-family:var(--font);font-size:12px;text-align:left;padding:9px 13px;border-radius:var(--r-sm);cursor:pointer;transition:all .2s;font-weight:500}
.ajuda-nav-item:hover{background:var(--surface3);color:var(--text)}
.ajuda-nav-item.active{background:rgba(91,138,247,.1);color:var(--accent);font-weight:700}
.ajuda-content{overflow-y:auto;padding:30px 34px}
.ajuda-section{display:none}
.ajuda-section.active{display:block}
.ajuda-sec-title{font-size:17px;font-weight:800;color:var(--text);margin-bottom:18px;padding-bottom:12px;border-bottom:1px solid var(--border2);letter-spacing:-.02em}
.ajuda-p{font-size:13px;color:var(--muted);line-height:2;margin-bottom:18px}
.ajuda-item{background:var(--surface3);border:1px solid var(--border2);border-radius:var(--r-md);padding:18px;margin-bottom:13px}
.ai-label{font-size:12px;font-weight:700;color:var(--text);margin-bottom:9px;letter-spacing:-.01em}
.ai-text{font-size:12px;color:var(--muted);line-height:2}
.ai-tip{margin-top:12px;font-size:11px;color:var(--yellow);padding:9px 14px;background:rgba(240,192,64,.05);border:1px solid rgba(240,192,64,.14);border-radius:var(--r-sm);line-height:1.8}

/* ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ */
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:768px){
  .day-body{grid-template-columns:1fr}
  .add-err-grid{grid-template-columns:1fr 1fr}
  .day-hours-grid{grid-template-columns:repeat(4,1fr)}
  .cycle-stats-mini{display:none}
  .day-reviews-col{display:none}
  .day-info{border-right:none;min-width:unset}
}
@media(max-width:640px){
  .ajuda-body{grid-template-columns:1fr}
  .ajuda-nav{flex-direction:row;overflow-x:auto;border-right:none;border-bottom:1px solid var(--border2);padding:8px}
  .ajuda-nav-item{white-space:nowrap}
  .ajuda-content{padding:20px}
  .agenda-day-row{grid-template-columns:1fr}
  .agenda-date{text-align:left}
  .container{padding:36px 18px 100px}
}
.topics li{font-size:12px;color:#9aa4c0;line-height:1.55;padding:10px 14px 10px 14px;position:relative;border-left:2px solid var(--border2);background:rgba(255,255,255,.02);border-radius:0 7px 7px 0}
.topics li.is-completo{border-left-color:rgba(66,232,160,.45)}
.topics li.is-parcial{border-left-color:rgba(245,200,66,.45)}
.t-nome{font-family:'Inter',sans-serif;font-size:13px;font-weight:700;color:var(--text);display:flex;align-items:flex-start;gap:6px;flex-wrap:wrap;margin-bottom:6px}
.t-meta{font-size:11px;color:var(--muted);margin-top:5px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.t-qs{color:var(--green);font-weight:700;font-size:12px}
.t-total{color:#dde2f0;font-size:11px}
.t-h{color:var(--yellow);font-weight:600;font-size:11px}
.t-bank-qty{color:#dde2f0;font-size:10px;opacity:.85}
.t-bar{width:100%;height:2px;background:var(--border2);border-radius:2px;margin-top:7px;overflow:hidden}
.t-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--accent),var(--green))}
.stag{display:inline-block;font-size:9px;padding:2px 6px;border-radius:3px;vertical-align:middle;letter-spacing:.04em;font-weight:700}
.stag-g{background:rgba(240,101,74,.12);border:1px solid rgba(240,101,74,.25);color:var(--orange)}
.stag-m{background:rgba(245,200,66,.1);border:1px solid rgba(245,200,66,.22);color:var(--yellow)}
.stag-p{background:rgba(66,232,160,.08);border:1px solid rgba(66,232,160,.2);color:var(--green)}

/* ‚îÄ‚îÄ ACCORDION ‚îÄ‚îÄ */
.hier-wrap{margin-top:12px;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--surface2)}
.hier-toggle{width:100%;display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:none;border:none;cursor:pointer;color:var(--muted);font-family:'JetBrains Mono',monospace;font-size:10px;letter-spacing:.06em;text-transform:uppercase;transition:background .2s;gap:8px}
.hier-toggle:hover{background:rgba(79,126,245,.06);color:var(--accent)}
.hier-toggle .ht-left{display:flex;align-items:center;gap:7px}
.hier-toggle .ht-arrow{font-size:10px;transition:transform .25s;color:var(--muted2)}
.hier-toggle.open .ht-arrow{transform:rotate(90deg)}
.hier-body{display:none;border-top:1px solid var(--border)}
.hier-body.open{display:block}
.hier-cat{border-bottom:1px solid var(--border)}
.hier-cat:last-child{border-bottom:none}
.hier-cat-hdr{display:flex;align-items:center;justify-content:space-between;padding:8px 13px;cursor:pointer;transition:background .2s;gap:8px}
.hier-cat-hdr:hover{background:rgba(255,255,255,.03)}
.hier-cat-hdr .hc-name{font-family:'Inter',sans-serif;font-size:11px;font-weight:700;color:var(--text);flex:1}
.hier-cat-hdr .hc-qty{font-size:10px;color:var(--green);white-space:nowrap}
.hier-cat-hdr .hc-arr{font-size:9px;color:var(--muted2);transition:transform .2s}
.hier-cat-hdr.open .hc-arr{transform:rotate(90deg)}
.hier-cat-body{display:none;padding:4px 0 8px}
.hier-cat-body.open{display:block}
.hier-item{display:flex;align-items:flex-start;gap:0;padding:3px 13px 3px 0;line-height:1.5}
.hier-item .hi-code{font-size:9px;color:var(--muted2);min-width:52px;padding-left:13px;flex-shrink:0;padding-top:1px;font-family:'JetBrains Mono',monospace}
.hier-item .hi-name{font-size:11px;color:#8a94b0;flex:1}
.hier-item .hi-qty{font-size:9px;color:#dde2f0;white-space:nowrap;padding-left:6px;padding-top:1px;opacity:.85}
.hier-item .hi-sess-qs{font-size:9px;font-weight:700;white-space:nowrap;padding-left:6px;padding-top:1px;color:var(--green)}
.hier-item .hi-acum-qs{font-size:9px;white-space:nowrap;padding-left:4px;padding-top:1px;color:var(--yellow)}
.hier-item[data-depth="0"]{background:rgba(255,255,255,.02)}
.hier-item[data-depth="0"] .hi-name{color:var(--text);font-weight:500}
.hier-item[data-depth="0"] .hi-code{color:var(--accent);opacity:.7}
.hier-item[data-depth="1"] .hi-code{color:var(--muted)}
.hier-item[data-depth="2"] .hi-name{color:#6a74a0;font-size:10.5px}
.hier-item[data-depth="3"] .hi-name{color:#5a647a;font-size:10px;font-style:italic}
.divider{margin:12px 0;border:none;border-top:1px solid var(--border)}
.folga-msg{padding:14px 20px;font-size:12px;color:var(--muted);font-style:italic}

/* ‚îÄ‚îÄ DAY FOOTER ‚îÄ‚îÄ */
.day-footer{display:flex;align-items:center;justify-content:space-between;padding:11px 18px;border-top:1px solid var(--border);background:rgba(255,255,255,.012);gap:10px;flex-wrap:wrap}
.btn-concluir{font-family:'Inter',sans-serif;font-weight:700;font-size:11px;letter-spacing:.05em;padding:8px 18px;border-radius:7px;border:1px solid rgba(66,232,160,.35);background:rgba(66,232,160,.07);color:var(--green);cursor:pointer;transition:all .22s}
</style>
</head>
<body>

<!-- STICKY NAV -->
<div class="sticky-nav" id="sticky-nav">
  <div class="sticky-nav-inner">
    <span class="sticky-nav-title">üìö Plano de Estudos</span>
    <div class="tabs" id="sticky-tabs">
      <button class="tab active" onclick="switchTab('plano')">üìÖ Plano</button>
      <button class="tab" onclick="switchTab('caderno')" id="sticky-tab-caderno">üìì Caderno <span class="tab-badge" id="ce-badge2" style="display:none">0</span></button>
      <button class="tab" onclick="switchTab('indice')">üìã √çndice</button>
      <button class="tab" onclick="abrirAjuda()">‚ùì Ajuda</button>
    </div>
    <span class="save-ok-sticky" id="save-ok-sticky">‚úì Salvo</span>
  </div>
</div>

<div class="container">
  <header style="margin-bottom:28px;animation:fadeUp .6s ease both">
    <div class="header-tag">Estudo Reverso por Quest√£o ‚Äî TEC Concursos</div>
    <h1>Plano de Estudos</h1>
    <p class="header-meta">Configure data, carga por dia e dura√ß√£o ‚Äî plano gerado automaticamente com <span class="hl">revis√£o espa√ßada integrada</span></p>
  </header>

  <div class="tabs-wrap">
    <div class="tabs" id="main-tabs">
      <button class="tab active" id="tab-btn-plano" onclick="switchTab('plano')">üìÖ Plano</button>
      <button class="tab" onclick="switchTab('caderno')" id="tab-btn-caderno">üìì Caderno de Erros <span class="tab-badge" id="ce-badge" style="display:none">0</span></button>
      <button class="tab" id="tab-btn-indice" onclick="switchTab('indice')">üìã √çndice TEC</button>
      <button class="tab" id="tab-btn-ajuda" onclick="abrirAjuda()">‚ùì Como Usar</button>
    </div>
    <span class="save-ok" id="save-ok">‚úì Progresso salvo</span>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: PLANO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-content active" id="tab-plano">
    <div class="panel">
      <div class="panel-title"><span class="icon">‚öô</span> Configura√ß√µes do Plano</div>
      <div class="config-grid">
        <div class="field">
          <label>Data de in√≠cio</label>
          <input type="date" id="data-inicio">
        </div>
        <div class="field">
          <label>Dura√ß√£o do estudo</label>
          <select id="duracao-meses">
            <option value="1">1 m√™s</option>
            <option value="2">2 meses</option>
            <option value="3" selected>3 meses</option>
            <option value="4">4 meses</option>
            <option value="6">6 meses</option>
            <option value="9">9 meses</option>
            <option value="12">12 meses</option>
          </select>
        </div>
        <div class="field">
          <label>Quest√µes / hora</label>
          <div class="range-label">
            <span class="range-big" id="qph-val">15</span>
            <span class="range-unit">quest√µes/h</span>
          </div>
          <input type="range" id="qph" min="5" max="40" value="15" step="1" oninput="syncRange('qph','qph-val')">
        </div>
        <div class="field">
          <label>Familiaridade</label>
          <select id="nivel">
            <option value="1.0" selected>Normal ‚Äî uso o valor acima</option>
            <option value="0.85">Devagar ‚Äî ritmo um pouco menor</option>
            <option value="0.7">Bem devagar ‚Äî ritmo bem reduzido</option>
          </select>
        </div>
      </div>

      <div class="panel-title" style="margin-bottom:14px"><span class="icon">‚è∞</span> Carga hor√°ria por dia</div>
      <div class="day-hours-grid" id="day-hours-grid"></div>

      <div class="btn-row">
        <button class="btn btn-primary" onclick="gerarPlano()">‚ñ∂ Gerar Plano</button>
        <button class="btn btn-ghost" onclick="confirmarReset()">‚Ü∫ Reiniciar tudo</button>
      </div>
      <div class="pills" id="pills" style="display:none">
        <div class="pill">Ritmo: <b id="p-ritmo">‚Äî</b></div>
        <div class="pill">Qs/semana: <b id="p-qsem">‚Äî</b></div>
        <div class="pill">Semanas: <b id="p-sem">‚Äî</b></div>
        <div class="pill">Total banco: <b id="p-total">‚Äî</b></div>
        <div class="pill">Per√≠odo: <b id="p-periodo">‚Äî</b></div>
      </div>
    </div>

    <div class="panel" id="progress-panel" style="display:none">
      <div class="panel-title"><span class="icon">üìä</span> Progresso por mat√©ria</div>
      <div class="mat-grid" id="mat-grid"></div>
    </div>

    <div class="legend">
      <div class="leg"><div class="leg-dot" style="background:var(--accent)"></div>TI</div>
      <div class="leg"><div class="leg-dot" style="background:var(--orange)"></div>Portugu√™s</div>
      <div class="leg"><div class="leg-dot" style="background:var(--green)"></div>Matem√°tica</div>
      <div class="leg"><div class="leg-dot" style="background:var(--purple)"></div>Prob./Estat.</div>
      <div class="leg"><div class="leg-dot" style="background:var(--yellow)"></div>Ingl√™s ¬∑ Reda√ß√£o</div>
      <div class="leg"><div class="leg-dot" style="background:var(--orange)"></div>Conhec. Banc√°rios</div>
      <div class="leg"><div class="leg-dot" style="background:var(--green)"></div>Atualidades</div>
    </div>

    <div id="plano-output">
      <div style="text-align:center;padding:60px;color:var(--muted)">
        <div style="font-size:36px;margin-bottom:12px">üìö</div>
        <p>Configure acima e clique em <b style="color:var(--text)">Gerar Plano</b></p>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: CADERNO DE ERROS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-content" id="tab-caderno">
    <div class="panel">
      <div class="ce-top">
        <div>
          <div class="panel-title" style="margin-bottom:6px"><span class="icon">üìì</span> Caderno de Erros ‚Äî Revis√£o Espa√ßada</div>
          <p style="font-size:11px;color:var(--muted);line-height:1.8">Registre erros por mat√©ria. O sistema agenda revis√µes autom√°ticas baseadas na curva do esquecimento.</p>
        </div>
        <div class="ce-stats" id="ce-stats">
          <div class="ce-stat"><div class="ce-stat-val" id="ce-total-reg" style="color:var(--accent)">0</div><div class="ce-stat-lbl">Registros</div></div>
          <div class="ce-stat"><div class="ce-stat-val" id="ce-pendentes" style="color:var(--yellow)">0</div><div class="ce-stat-lbl">Revis√µes pendentes</div></div>
          <div class="ce-stat"><div class="ce-stat-val" id="ce-atrasadas" style="color:var(--red)">0</div><div class="ce-stat-lbl">Atrasadas</div></div>
          <div class="ce-stat"><div class="ce-stat-val" id="ce-concluidas" style="color:var(--green)">0</div><div class="ce-stat-lbl">Conclu√≠das</div></div>
        </div>
      </div>

      <!-- Seletor de intervalos de revis√£o -->
      <div style="margin-bottom:20px;padding:14px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:10px">
        <div style="font-family:'Inter',sans-serif;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px">‚ö° Intervalo de Revis√µes</div>
        <div class="rev-presets" id="rev-presets">
          <button class="rev-preset-btn" onclick="setPreset('ebbinghaus')" id="preset-ebbinghaus">Ebbinghaus: 1¬∑7¬∑16¬∑35d</button>
          <button class="rev-preset-btn active" onclick="setPreset('concursos')" id="preset-concursos">Concursos: 1¬∑3¬∑7¬∑14¬∑30d ‚úì</button>
          <button class="rev-preset-btn" onclick="setPreset('intensivo')" id="preset-intensivo">Intensivo: 1¬∑2¬∑4¬∑7¬∑15d</button>
          <button class="rev-preset-btn" onclick="setPreset('relaxado')" id="preset-relaxado">Leve: 1¬∑7¬∑30d</button>
        </div>
        <div style="font-size:10px;color:var(--muted2);margin-top:4px" id="preset-desc">Padr√£o cient√≠fico recomendado para concursos ‚Äî 5 revis√µes com espa√ßamento progressivo baseado na curva do esquecimento.</div>
      </div>

      <div class="add-error-panel">
        <div class="add-err-title">+ Adicionar registro de erros</div>
        <div class="add-err-grid" style="grid-template-columns:1fr 1fr 1fr 1fr auto">
          <div class="field">
            <label>Mat√©ria</label>
            <select id="ce-mat" onchange="updateSubMat()">
              <option value="TI">TI</option>
              <option value="PT">Portugu√™s</option>
              <option value="MT">Matem√°tica</option>
              <option value="PROB">Prob./Estat.</option>
              <option value="EN">Ingl√™s</option>
              <option value="BC">Conhec. Banc√°rios</option>
              <option value="AT">Atualidades</option>
              <option value="RED">Reda√ß√£o</option>
            </select>
            <div class="sub-mat-select" id="sub-mat-wrap">
              <select id="ce-submat" style="background:var(--surface);border:1px solid var(--border2);border-radius:8px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:11px;padding:7px 10px;outline:none;width:100%;margin-top:6px">
                <option value="">‚Äî Selecionar subt√≥pico ‚Äî</option>
              </select>
            </div>
          </div>
          <div class="field">
            <label>T√≥pico / Anota√ß√£o (opcional)</label>
            <input type="text" id="ce-topico" placeholder="ex: Concord√¢ncia verbal, SQL JOIN...">
          </div>
          <div class="field">
            <label>Data do erro</label>
            <input type="date" id="ce-data">
          </div>
          <div class="field">
            <label>Link da quest√£o (opcional)</label>
            <input type="text" id="ce-link" placeholder="https://www.tecconcursos.com.br/...">
          </div>
          <div class="field" style="justify-content:flex-end">
            <button class="btn btn-green btn-sm" onclick="adicionarErro()">+ Adicionar</button>
          </div>
        </div>
      </div>

      <div class="agenda-section" id="agenda-section">
        <div class="agenda-title"><span>üìÜ</span> Agenda de revis√µes (pr√≥ximos 30 dias)</div>
        <div class="agenda-timeline" id="agenda-timeline"></div>
      </div>

      <div class="section-divider"></div>

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px">
        <div class="panel-title" style="margin-bottom:0"><span class="icon">üìã</span> Todos os registros</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <select id="filter-mat" onchange="renderCaderno()" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:11px;padding:6px 10px;outline:none">
            <option value="">Todas as mat√©rias</option>
            <option value="TI">TI</option><option value="PT">Portugu√™s</option>
            <option value="MT">Matem√°tica</option><option value="PROB">Prob./Estat.</option>
            <option value="EN">Ingl√™s</option><option value="BC">Conhec. Banc√°rios</option>
            <option value="AT">Atualidades</option><option value="RED">Reda√ß√£o</option>
          </select>
          <select id="filter-status" onchange="renderCaderno()" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:11px;padding:6px 10px;outline:none">
            <option value="">Todos os status</option>
            <option value="pending">Com revis√µes pendentes</option>
            <option value="overdue">Atrasados</option>
            <option value="done">Conclu√≠dos</option>
          </select>
        </div>
      </div>
      <div class="err-table-wrap" id="err-table-wrap">
        <div class="empty-ce"><div class="icon">üì≠</div><p>Nenhum erro registrado ainda.<br>Adicione acima!</p></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TAB: √çNDICE TEC ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="tab-content" id="tab-indice">
    <div class="panel">
      <div class="panel-title"><span class="icon">üìã</span> √çndice Completo ‚Äî TEC Concursos</div>
      <p style="font-size:11px;color:var(--muted);margin-bottom:18px;line-height:1.8">Todos os t√≥picos do edital com hierarquia completa e quantidade de quest√µes. Clique nas mat√©rias para expandir.</p>
      <div id="indice-full"></div>
    </div>
  </div>

</div><!-- /container -->

<!-- MODAL RESET -->
<div class="modal-overlay" id="modal-reset" style="display:none">
  <div class="modal-box">
    <div class="modal-title">Reiniciar tudo?</div>
    <div class="modal-text">Todo o progresso do plano ser√° apagado. O caderno de erros <b>n√£o</b> ser√° afetado.<br><br>Essa a√ß√£o n√£o pode ser desfeita.</div>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="fecharModal()">Cancelar</button>
      <button class="modal-confirm" onclick="executarReset()">Sim, reiniciar</button>
    </div>
  </div>
</div>

<!-- MODAL AJUDA -->
<div class="modal-overlay" id="modal-ajuda" style="display:none" onclick="fecharAjudaFora(event)">
  <div class="ajuda-box">
    <div class="ajuda-header">
      <div>
        <div class="ajuda-super">Guia Completo</div>
        <div class="ajuda-title">Como usar o Plano de Estudos</div>
      </div>
      <button class="ajuda-close" onclick="fecharAjuda()">‚úï</button>
    </div>
    <div class="ajuda-body">
      <nav class="ajuda-nav">
        <button class="ajuda-nav-item active" onclick="showSection('s-visao')">üó∫ Vis√£o geral</button>
        <button class="ajuda-nav-item" onclick="showSection('s-config')">‚öô Configura√ß√µes</button>
        <button class="ajuda-nav-item" onclick="showSection('s-plano')">üìÖ O Plano</button>
        <button class="ajuda-nav-item" onclick="showSection('s-caderno')">üìì Caderno de erros</button>
        <button class="ajuda-nav-item" onclick="showSection('s-revisao')">üß† Revis√£o espa√ßada</button>
        <button class="ajuda-nav-item" onclick="showSection('s-dicas')">üí° Dicas e FAQ</button>
      </nav>
      <div class="ajuda-content">
        <div class="ajuda-section active" id="s-visao">
          <div class="ajuda-sec-title">üó∫ Vis√£o geral</div>
          <p class="ajuda-p">Plano de estudos reverso por quest√£o com revis√£o espa√ßada integrada e registro de progresso por mat√©ria.</p>
          <div class="ajuda-item">
            <div class="ai-label">üìä Progresso por mat√©ria</div>
            <div class="ai-text">Ap√≥s gerar o plano, um painel mostra o avan√ßo em cada disciplina: t√≥picos cobertos, porcentagem do banco e volta atual.</div>
          </div>
          <div class="ajuda-item">
            <div class="ai-label">üìì Caderno de Erros integrado</div>
            <div class="ai-text">Registre quest√µes erradas com mat√©ria, subt√≥pico e data. O sistema agenda revis√µes autom√°ticas que aparecem no plano.</div>
          </div>
        </div>
        <div class="ajuda-section" id="s-config">
          <div class="ajuda-sec-title">‚öô Configura√ß√µes</div>
          <div class="ajuda-item"><div class="ai-label">üìÖ Data de in√≠cio</div><div class="ai-text">Define o come√ßo do ciclo. O dia de hoje fica destacado em verde no plano.</div></div>
          <div class="ajuda-item"><div class="ai-label">‚ö° Quest√µes / hora</div><div class="ai-text">Iniciante: 10‚Äì15 qs/h. Aumente conforme evoluir.</div></div>
          <div class="ajuda-item"><div class="ai-label">üåô Folga</div><div class="ai-text">Clique "Folga" em qualquer dia para zer√°-lo. Clique "Ativar" para restaurar.</div></div>
        </div>
        <div class="ajuda-section" id="s-plano">
          <div class="ajuda-sec-title">üìÖ Entendendo o Plano</div>
          <div class="ajuda-item">
            <div class="ai-label">Semanas minimizadas</div>
            <div class="ai-text">Cada semana pode ser minimizada clicando no cabe√ßalho. O dia atual fica sempre expandido por padr√£o.</div>
          </div>
          <div class="ajuda-item">
            <div class="ai-label">Legenda de tamanho</div>
            <div class="ai-text"><b>GRANDE</b> = 20+ quest√µes ¬∑ <b>M√âDIO</b> = 6‚Äì19 ¬∑ <b>PEQUENO</b> = at√© 5</div>
          </div>
        </div>
        <div class="ajuda-section" id="s-caderno">
          <div class="ajuda-sec-title">üìì Caderno de Erros</div>
          <div class="ajuda-item"><div class="ai-label">Subt√≥picos</div><div class="ai-text">Ao selecionar a mat√©ria, aparece um seletor de subt√≥picos com todos os cap√≠tulos do banco.</div></div>
          <div class="ajuda-item"><div class="ai-label">Intervalos de revis√£o</div><div class="ai-text">Escolha entre 4 presets: Ebbinghaus cl√°ssico, Concursos (recomendado), Intensivo e Leve.</div></div>
        </div>
        <div class="ajuda-section" id="s-revisao">
          <div class="ajuda-sec-title">üß† Revis√£o Espa√ßada</div>
          <div class="ajuda-item">
            <div class="ai-label">Intervalos recomendados (Concursos)</div>
            <div class="ai-text">
              <b style="color:var(--yellow)">+1 dia</b> ‚Üí Consolida√ß√£o inicial<br>
              <b style="color:var(--yellow)">+3 dias</b> ‚Üí Refor√ßo<br>
              <b style="color:var(--yellow)">+7 dias</b> ‚Üí Fixa√ß√£o semanal<br>
              <b style="color:var(--yellow)">+14 dias</b> ‚Üí Consolida√ß√£o quinzenal<br>
              <b style="color:var(--yellow)">+30 dias</b> ‚Üí Mem√≥ria de longo prazo
            </div>
            <div class="ai-tip">üí° Padr√£o 1¬∑3¬∑7¬∑14¬∑30 ‚Äî o mais adotado por concurseiros experientes.</div>
          </div>
        </div>
        <div class="ajuda-section" id="s-dicas">
          <div class="ajuda-sec-title">üí° Dicas e FAQ</div>
          <div class="ajuda-item">
            <div class="ai-label">Rotina recomendada</div>
            <div class="ai-text">
              <b style="color:var(--yellow)">‚ë† 5min</b> ‚Äî abra o plano, veja o dia de hoje<br>
              <b style="color:var(--yellow)">‚ë° 35min</b> ‚Äî revis√µes do Caderno<br>
              <b style="color:var(--yellow)">‚ë¢ Estudo</b> ‚Äî siga os t√≥picos indicados<br>
              <b style="color:var(--yellow)">‚ë£ 5min</b> ‚Äî adicione erros no Caderno
            </div>
          </div>
          <div class="ajuda-item">
            <div class="ai-label">Persist√™ncia dos dados</div>
            <div class="ai-text">Tudo fica salvo no localStorage do navegador. Use sempre o mesmo navegador e perfil.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DADOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcSize(qty){
  if(qty>=20) return 'g';
  if(qty>=6)  return 'm';
  return 'p';
}

const TOPICOS_HIER={
  PT:{label:'Portugu√™s',categories:[{nome:'L√≠ngua Portuguesa',qty:394,items:[
    {hier:'01',nome:'Ortografia',qty:15,depth:0},
    {hier:'01.01',nome:'Ortografia - Casos Gerais e Emprego das Letras',qty:3,depth:1},
    {hier:'01.02',nome:'Fatos da L√≠ngua Portuguesa',qty:2,depth:1},
    {hier:'01.03',nome:'Inicial Mai√∫scula',qty:1,depth:1},
    {hier:'01.04',nome:'Acentua√ß√£o',qty:6,depth:1},
    {hier:'01.05',nome:'Uso do H√≠fen',qty:2,depth:1},
    {hier:'01.06',nome:'Quest√µes Mescladas de Ortografia',qty:1,depth:1},
    {hier:'02',nome:'Morfologia',qty:37,depth:0},
    {hier:'02.01',nome:'Classes de Palavras',qty:37,depth:1},
    {hier:'02.01.01',nome:'Substantivo',qty:3,depth:2},
    {hier:'02.01.02',nome:'Adjetivo',qty:3,depth:2},
    {hier:'02.01.03',nome:'Verbo',qty:15,depth:2},
    {hier:'02.01.03.01',nome:'Conjuga√ß√£o e Emprego dos Modos e Tempos Verbais',qty:12,depth:3},
    {hier:'02.01.03.02',nome:'Locu√ß√£o Verbal',qty:2,depth:3},
    {hier:'02.01.03.03',nome:'Quest√µes Variadas de Verbo',qty:1,depth:3},
    {hier:'02.01.04',nome:'Pronomes',qty:2,depth:2},
    {hier:'02.01.05',nome:'Adv√©rbio',qty:2,depth:2},
    {hier:'02.01.06',nome:'Preposi√ß√£o',qty:1,depth:2},
    {hier:'02.01.07',nome:'Conjun√ß√£o',qty:9,depth:2},
    {hier:'02.01.08',nome:'Interjei√ß√£o',qty:1,depth:2},
    {hier:'02.01.09',nome:'Quest√µes Variadas de Classe de Palavras',qty:1,depth:2},
    {hier:'03',nome:'Coloca√ß√£o Pronominal',qty:18,depth:0},
    {hier:'04',nome:'Sintaxe',qty:8,depth:0},
    {hier:'04.01',nome:'Fun√ß√µes Sint√°ticas',qty:1,depth:1},
    {hier:'04.02',nome:'Ora√ß√µes Subordinadas Adjetivas',qty:1,depth:1},
    {hier:'04.03',nome:'Ora√ß√µes Subordinadas Adverbiais',qty:3,depth:1},
    {hier:'04.04',nome:'Ora√ß√µes Reduzidas',qty:2,depth:1},
    {hier:'04.05',nome:'Fun√ß√£o Sint√°tica dos Pronomes Pessoais √Åtonos',qty:1,depth:1},
    {hier:'05',nome:'Pontua√ß√£o',qty:31,depth:0},
    {hier:'06',nome:'Reg√™ncia',qty:30,depth:0},
    {hier:'06.01',nome:'Reg√™ncia Nominal e Verbal',qty:6,depth:1},
    {hier:'06.02',nome:'Crase',qty:24,depth:1},
    {hier:'07',nome:'Concord√¢ncia (Verbal e Nominal)',qty:37,depth:0},
    {hier:'08',nome:'Vozes (Voz Passiva e Voz Ativa)',qty:1,depth:0},
    {hier:'09',nome:'Coer√™ncia. Coes√£o',qty:38,depth:0},
    {hier:'10',nome:'Part√≠cula "Se"',qty:1,depth:0},
    {hier:'11',nome:'Voc√°bulo "Que"',qty:5,depth:0},
    {hier:'12',nome:'Interpreta√ß√£o de Textos',qty:148,depth:0},
    {hier:'13',nome:'Tipologia e G√™nero Textual',qty:6,depth:0},
    {hier:'14',nome:'Paralelismo',qty:1,depth:0},
    {hier:'15',nome:'Reescrita de Frases',qty:16,depth:0},
    {hier:'16',nome:'Outras Quest√µes de Portugu√™s',qty:2,depth:0}
  ]}]},
  MT:{label:'Matem√°tica',categories:[
    {nome:'Matem√°tica',qty:160,items:[
      {hier:'01',nome:'Conjuntos e N√∫meros',qty:41,depth:0},
      {hier:'01.01',nome:'Defini√ß√£o, Subconjuntos, Inclus√£o e Pertin√™ncia',qty:1,depth:1},
      {hier:'01.02',nome:'N√∫mero de Elementos (Uni√£o, Intersec√ß√£o, etc.)',qty:4,depth:1},
      {hier:'01.03',nome:'N√∫meros Naturais',qty:19,depth:1},
      {hier:'01.03.01',nome:'Adi√ß√£o, Subtra√ß√£o, Multiplica√ß√£o e Divis√£o',qty:13,depth:2},
      {hier:'01.03.02',nome:'Divisibilidade, N√∫meros Primos, MMC',qty:6,depth:2},
      {hier:'01.04',nome:'N√∫meros Inteiros',qty:4,depth:1},
      {hier:'01.05',nome:'N√∫meros Racionais',qty:10,depth:1},
      {hier:'01.05.01',nome:'Fra√ß√µes e D√≠zimas Peri√≥dicas',qty:4,depth:2},
      {hier:'01.05.02',nome:'Opera√ß√µes com N√∫meros Decimais',qty:6,depth:2},
      {hier:'01.06',nome:'Radicia√ß√£o e Potencia√ß√£o',qty:3,depth:1},
      {hier:'02',nome:'Proporcionalidade',qty:46,depth:0},
      {hier:'02.01',nome:'Propor√ß√µes. Grandezas Proporcionais',qty:5,depth:1},
      {hier:'02.02',nome:'Regra de Tr√™s',qty:8,depth:1},
      {hier:'02.02.01',nome:'Regra de Tr√™s Simples',qty:5,depth:2},
      {hier:'02.02.02',nome:'Regra de Tr√™s Composta',qty:3,depth:2},
      {hier:'02.03',nome:'Velocidade, Espa√ßo, Tempo',qty:1,depth:1},
      {hier:'02.04',nome:'Porcentagem',qty:32,depth:1},
      {hier:'03',nome:'Unidades de Medida',qty:12,depth:0},
      {hier:'04',nome:'Equa√ß√µes',qty:17,depth:0},
      {hier:'04.01',nome:'Equa√ß√µes de Primeiro Grau',qty:16,depth:1},
      {hier:'04.02',nome:'Equa√ß√µes de Segundo Grau e Biquadradas',qty:1,depth:1},
      {hier:'05',nome:'Logaritmo',qty:5,depth:0},
      {hier:'06',nome:'Progress√£o Aritm√©tica',qty:10,depth:0},
      {hier:'07',nome:'Progress√£o Geom√©trica',qty:6,depth:0},
      {hier:'08',nome:'Fun√ß√µes e Inequa√ß√µes',qty:11,depth:0},
      {hier:'08.01',nome:'Fun√ß√£o de Primeiro Grau',qty:2,depth:1},
      {hier:'08.02',nome:'Inequa√ß√µes de Primeiro Grau',qty:1,depth:1},
      {hier:'08.03',nome:'Fun√ß√£o de Segundo Grau',qty:3,depth:1},
      {hier:'08.04',nome:'Inequa√ß√µes de Segundo Grau',qty:3,depth:1},
      {hier:'08.05',nome:'Fun√ß√£o Exponencial e Inequa√ß√µes Exponenciais',qty:2,depth:1},
      {hier:'09',nome:'√Ålgebra Linear Elementar',qty:12,depth:0},
      {hier:'09.01',nome:'Matrizes',qty:3,depth:1},
      {hier:'09.02',nome:'Sistemas Lineares',qty:9,depth:1}
    ]},
    {nome:'Racioc√≠nio L√≥gico',qty:19,items:[
      {hier:'01',nome:'L√≥gica de Proposi√ß√µes',qty:14,depth:0},
      {hier:'01.01',nome:'Operadores L√≥gicos',qty:1,depth:1},
      {hier:'01.02',nome:'Tabela Verdade das Proposi√ß√µes Compostas',qty:1,depth:1},
      {hier:'01.03',nome:'Equival√™ncias L√≥gicas',qty:2,depth:1},
      {hier:'01.04',nome:'√Ålgebra de Proposi√ß√µes',qty:1,depth:1},
      {hier:'01.05',nome:'L√≥gica de Argumenta√ß√£o',qty:3,depth:1},
      {hier:'01.06',nome:'Associa√ß√£o de Informa√ß√µes',qty:3,depth:1},
      {hier:'01.07',nome:'Exerc√≠cios de "Verdade/Mentira"',qty:3,depth:1},
      {hier:'02',nome:'Sequ√™ncias de N√∫meros, Figuras, Letras',qty:5,depth:0}
    ]}
  ]},
  TI:{label:'TI',categories:[
    {nome:'Banco de Dados',qty:70,items:[
      {hier:'01',nome:'Projeto e Modelagem de Dados',qty:34,depth:0},
      {hier:'01.01',nome:'Conceitos e Fases de Projeto e Modelagem',qty:3,depth:1},
      {hier:'01.02',nome:'Modelo Entidade-Relacionamento (MER)',qty:11,depth:1},
      {hier:'01.03',nome:'Modelo Relacional',qty:20,depth:1},
      {hier:'01.03.01',nome:'Conceitos e Fundamentos de Modelo Relacional',qty:8,depth:2},
      {hier:'01.03.02',nome:'Normaliza√ß√£o',qty:7,depth:2},
      {hier:'01.03.03',nome:'Modelagem e Mapeamento ER-relacional',qty:5,depth:2},
      {hier:'02',nome:'Linguagem SQL',qty:17,depth:0},
      {hier:'02.01',nome:'Consultas e Comandos em SQL',qty:17,depth:1},
      {hier:'03',nome:'SGBD',qty:11,depth:0},
      {hier:'03.01',nome:'Defini√ß√µes e Propriedades do SGBD',qty:3,depth:1},
      {hier:'03.02',nome:'Vis√£o (View)',qty:1,depth:1},
      {hier:'03.03',nome:'Transa√ß√µes (Locks, ACID)',qty:1,depth:1},
      {hier:'03.04',nome:'Triggers',qty:3,depth:1},
      {hier:'03.05',nome:'PostgreSQL / MongoDB',qty:2,depth:1},
      {hier:'04',nome:'NoSQL e outros tipos de BD',qty:8,depth:0}
    ]},
    {nome:'Ci√™ncia de Dados e IA',qty:67,items:[
      {hier:'01',nome:'Bancos de Dados Dimensionais',qty:22,depth:0},
      {hier:'01.01',nome:'Business Intelligence e Analytics',qty:3,depth:1},
      {hier:'01.02',nome:'Data Warehouse e Data Mart',qty:12,depth:1},
      {hier:'01.03',nome:'Big Data',qty:7,depth:1},
      {hier:'02',nome:'Linguagens para Ci√™ncia de Dados',qty:25,depth:0},
      {hier:'02.01',nome:'Python (Conceitos e C√≥digos)',qty:8,depth:1},
      {hier:'02.02',nome:'Bibliotecas Python (NumPy, Pandas, etc.)',qty:13,depth:1},
      {hier:'02.03',nome:'Linguagem R / Scala',qty:4,depth:1},
      {hier:'03',nome:'Intelig√™ncia Artificial',qty:20,depth:0},
      {hier:'03.01',nome:'Conceitos de IA',qty:1,depth:1},
      {hier:'03.02',nome:'Machine Learning',qty:12,depth:1},
      {hier:'03.03',nome:'Redes Neurais',qty:2,depth:1},
      {hier:'03.04',nome:'NLP e Treinamento de Modelos',qty:4,depth:1},
      {hier:'03.05',nome:'Outros Assuntos de IA',qty:1,depth:1}
    ]},
    {nome:'Desenvolvimento de Sistemas',qty:58,items:[
      {hier:'01',nome:'Algoritmos e L√≥gica de Programa√ß√£o',qty:17,depth:0},
      {hier:'01.01',nome:'Defini√ß√£o de Algoritmos e Estruturas de Controle',qty:5,depth:1},
      {hier:'01.02',nome:'Vari√°veis, Subprogramas e Par√¢metros',qty:1,depth:1},
      {hier:'01.03',nome:'Estrutura de Dados',qty:11,depth:1},
      {hier:'02',nome:'Linguagens de Programa√ß√£o ‚Äî Java',qty:27,depth:0},
      {hier:'02.01',nome:'Conceitos e Propriedades do Java',qty:12,depth:1},
      {hier:'02.02',nome:'C√≥digos em Java',qty:15,depth:1},
      {hier:'03',nome:'Desenvolvimento Web ‚Äî TypeScript',qty:5,depth:0},
      {hier:'04',nome:'Desenvolvimento para Dispositivos M√≥veis',qty:9,depth:0}
    ]}
  ]},
  PROB:{label:'Estat√≠stica',categories:[{nome:'Estat√≠stica / Probabilidade',qty:98,items:[
    {hier:'01',nome:'Estat√≠stica Descritiva',qty:53,depth:0},
    {hier:'01.01',nome:'Conceitos Iniciais de Estat√≠stica',qty:1,depth:1},
    {hier:'01.02',nome:'Formas de Apresenta√ß√£o de Dados',qty:6,depth:1},
    {hier:'01.03',nome:'Medidas de Posi√ß√£o',qty:28,depth:1},
    {hier:'01.03.01',nome:'M√©dia',qty:13,depth:2},
    {hier:'01.03.02',nome:'Quantis (Mediana, Quartil, Decil, Percentil)',qty:8,depth:2},
    {hier:'01.03.03',nome:'Moda',qty:1,depth:2},
    {hier:'01.03.04',nome:'Quest√µes Mescladas de Medidas de Posi√ß√£o',qty:6,depth:2},
    {hier:'01.04',nome:'Medidas de Dispers√£o',qty:18,depth:1},
    {hier:'01.04.01',nome:'Intervalo Interquart√≠lico',qty:2,depth:2},
    {hier:'01.04.02',nome:'Desvio Padr√£o e Vari√¢ncia',qty:8,depth:2},
    {hier:'01.04.03',nome:'Coeficiente de Varia√ß√£o e Vari√¢ncia Relativa',qty:8,depth:2},
    {hier:'02',nome:'Probabilidade',qty:16,depth:0},
    {hier:'02.01',nome:'Introdu√ß√£o √† Probabilidade',qty:5,depth:1},
    {hier:'02.02',nome:'Probabilidade Condicional',qty:4,depth:1},
    {hier:'02.03',nome:'Teorema de Bayes',qty:7,depth:1},
    {hier:'03',nome:'Vari√°veis Aleat√≥rias',qty:13,depth:0},
    {hier:'03.01',nome:'Vari√°vel Aleat√≥ria Discreta',qty:4,depth:1},
    {hier:'03.02',nome:'Covari√¢ncia; Vari√¢ncia da Soma e da Diferen√ßa',qty:5,depth:1},
    {hier:'03.03',nome:'Correla√ß√£o Linear entre Vari√°veis Aleat√≥rias',qty:2,depth:1},
    {hier:'03.04',nome:'Vari√°vel Aleat√≥ria Cont√≠nua',qty:2,depth:1},
    {hier:'04',nome:'Distribui√ß√£o Binomial',qty:4,depth:0},
    {hier:'04.01',nome:'Distribui√ß√£o Binomial',qty:4,depth:1},
    {hier:'05',nome:'Distribui√ß√£o Normal',qty:3,depth:0},
    {hier:'05.01',nome:'Distribui√ß√£o Normal',qty:3,depth:1},
    {hier:'06',nome:'Estimadores e Distribui√ß√µes Amostrais',qty:2,depth:0},
    {hier:'07',nome:'Caracter√≠sticas dos Estimadores',qty:2,depth:0},
    {hier:'08',nome:'Testes de Hip√≥teses',qty:5,depth:0},
    {hier:'08.01',nome:'Teste de Hip√≥teses: Introdu√ß√£o',qty:1,depth:1},
    {hier:'08.02',nome:'Teste de Hip√≥teses para a M√©dia',qty:3,depth:1},
    {hier:'08.03',nome:'Teste de Hip√≥teses para a Propor√ß√£o',qty:1,depth:1}
  ]}]},
  EN:{label:'Ingl√™s',categories:[{nome:'L√≠ngua Inglesa',qty:100,items:[
    {hier:'01',nome:'Interpreta√ß√£o de Textos (Understanding)',qty:44,depth:0},
    {hier:'02',nome:'Gram√°tica (Grammatics)',qty:15,depth:0},
    {hier:'02.01',nome:'Morfologia e Classe de Palavras (Morphology)',qty:15,depth:1},
    {hier:'02.01.01',nome:'Adjetivos (Ingl√™s)',qty:1,depth:2},
    {hier:'02.01.02',nome:'Verbos (Verbs)',qty:1,depth:2},
    {hier:'02.01.03',nome:'Pronomes (Pronouns)',qty:1,depth:2},
    {hier:'02.01.04',nome:'Adv√©rbios (Adverbs)',qty:1,depth:2},
    {hier:'02.01.05',nome:'Conjun√ß√µes e Conectivos',qty:11,depth:2},
    {hier:'03',nome:'Sem√¢ntica e Significado de Voc√°bulos',qty:36,depth:0},
    {hier:'03.01',nome:'Significado de Palavras e Express√µes',qty:9,depth:1},
    {hier:'03.02',nome:'Substitui√ß√£o de Palavras e Reescrita de Frases',qty:15,depth:1},
    {hier:'03.03',nome:'Referencia√ß√£o, An√°fora e Cat√°fora',qty:12,depth:1},
    {hier:'04',nome:'Sem Classifica√ß√£o',qty:5,depth:0}
  ]}]},
  BC:{label:'Conhecimentos Banc√°rios',categories:[
    {nome:'Direito Digital (LGPD)',qty:13,items:[
      {hier:'01',nome:'LGPD ‚Äî Lei n¬∫ 13.709/2018',qty:13,depth:0},
      {hier:'01.01',nome:'Disposi√ß√µes Preliminares (arts. 1¬∫ a 6¬∫)',qty:10,depth:1},
      {hier:'01.02',nome:'Tratamento de Dados (arts. 7¬∫ a 16)',qty:2,depth:1},
      {hier:'01.03',nome:'Seguran√ßa e Boas Pr√°ticas (arts. 46 a 51)',qty:1,depth:1}
    ]},
    {nome:'√âtica e Conduta',qty:11,items:[
      {hier:'01',nome:'C√≥digo de √âtica do Banco do Brasil',qty:10,depth:0},
      {hier:'02',nome:'√âtica e Conduta Profissional',qty:1,depth:0}
    ]},
    {nome:'Finan√ßas e Conhecimentos Banc√°rios',qty:241,items:[
      {hier:'01',nome:'Sistema Financeiro Nacional',qty:97,depth:0},
      {hier:'01.01',nome:'Classifica√ß√£o e Subsistemas do SFN',qty:2,depth:1},
      {hier:'01.02',nome:'√ìrg√£os e Entidades do SFN',qty:84,depth:1},
      {hier:'01.03',nome:'Cust√≥dia, Compensa√ß√£o e Liquida√ß√£o',qty:4,depth:1},
      {hier:'01.04',nome:'Outras Institui√ß√µes (ANBIMA, FEBRABAN, etc.)',qty:4,depth:1},
      {hier:'01.05',nome:'Institui√ß√µes e Acordos Internacionais',qty:3,depth:1},
      {hier:'02',nome:'Mercados Financeiros',qty:75,depth:0},
      {hier:'02.01',nome:'Mercado Monet√°rio',qty:12,depth:1},
      {hier:'02.02',nome:'Mercado de Cr√©dito',qty:4,depth:1},
      {hier:'02.03',nome:'Mercados de Capitais',qty:16,depth:1},
      {hier:'02.04',nome:'Mercado Cambial',qty:43,depth:1},
      {hier:'03',nome:'Produtos, Servi√ßos Financeiros e Garantias',qty:51,depth:0},
      {hier:'03.01',nome:'Contas de Dep√≥sitos e CDB/RDB',qty:7,depth:1},
      {hier:'03.02',nome:'Fundos de Investimento',qty:3,depth:1},
      {hier:'03.03',nome:'Cr√©dito Rural',qty:9,depth:1},
      {hier:'03.04',nome:'Opera√ß√µes de Cr√©dito',qty:11,depth:1},
      {hier:'03.05',nome:'Leasing e Outros Servi√ßos',qty:15,depth:1},
      {hier:'03.06',nome:'Garantias Banc√°rias',qty:6,depth:1},
      {hier:'08',nome:'Juros e Spread Banc√°rio',qty:7,depth:0},
      {hier:'09',nome:'Combate √† lavagem de dinheiro',qty:4,depth:0}
    ]}
  ]},
  AT:{label:'Atualidades do Mercado Financeiro',categories:[{nome:'Atualidades do Mercado Financeiro',qty:248,items:[
    {hier:'01',nome:'Atualidades do Mercado Financeiro',qty:248,depth:0},
    {hier:'01.01',nome:'Os Bancos na Era Digital',qty:32,depth:1},
    {hier:'01.02',nome:'Internet Banking',qty:7,depth:1},
    {hier:'01.03',nome:'Mobile Banking',qty:17,depth:1},
    {hier:'01.04',nome:'Open Finance (Antigo Open Banking)',qty:34,depth:1},
    {hier:'01.05',nome:'Novos Modelos de Neg√≥cios',qty:5,depth:1},
    {hier:'01.06',nome:'Fintechs, Startups e Big Techs',qty:32,depth:1},
    {hier:'01.07',nome:'Shadow Banking',qty:12,depth:1},
    {hier:'01.08',nome:'Blockchain, Bitcoin e Criptomoedas',qty:33,depth:1},
    {hier:'01.09',nome:'Marketplace',qty:6,depth:1},
    {hier:'01.10',nome:'Correspondentes Banc√°rios',qty:13,depth:1},
    {hier:'01.11',nome:'Arranjos de Pagamentos',qty:22,depth:1},
    {hier:'01.12',nome:'Sistema PIX',qty:25,depth:1},
    {hier:'01.13',nome:'Segmenta√ß√£o e Intera√ß√µes Digitais',qty:7,depth:1},
    {hier:'01.14',nome:'Transforma√ß√£o Digital no Sistema Financeiro',qty:3,depth:1}
  ]}]},
  RED:{label:'Reda√ß√£o',categories:[{nome:'Reda√ß√£o (Pr√°tica)',qty:0,items:[
    {hier:'01',nome:'Tipologia e G√™nero Textual + Coer√™ncia e Coes√£o',qty:0,depth:0},
    {hier:'02',nome:'Paralelismo + Reescrita',qty:0,depth:0},
    {hier:'03',nome:'Pr√°tica de Reda√ß√£o Dissertativa-Argumentativa',qty:0,depth:0}
  ]}]}
};

// ‚îÄ‚îÄ TOPICOS plano (depth=0) ‚îÄ‚îÄ
const TOPICOS = {};
Object.keys(TOPICOS_HIER).forEach(function(mat){
  var hierData = TOPICOS_HIER[mat];
  var flat = [];
  hierData.categories.forEach(function(cat){
    if(mat === 'RED'){
      cat.items.forEach(function(item, i){
        flat.push({id: mat.toLowerCase()+String(i+1).padStart(2,'0'), nome: item.nome, qty: 0, size: 'p', isPratica: true});
      });
    } else {
      cat.items.forEach(function(item){
        if(item.depth === 0){
          flat.push({id: mat.toLowerCase()+String(flat.length+1).padStart(2,'0'), nome: item.nome, qty: item.qty, size: calcSize(item.qty)});
        }
      });
    }
  });
  TOPICOS[mat] = flat;
});

var TOTAIS = {PT:394,MT:179,TI:195,PROB:98,EN:100,BC:280,AT:248,RED:0};
var MAT_COLORS = {TI:'var(--accent)',PT:'var(--orange)',MT:'var(--green)',PROB:'var(--purple)',EN:'var(--yellow)',BC:'var(--orange)',AT:'var(--green)',RED:'var(--yellow)'};
var MAT_LABELS = {TI:'TI',PT:'Portugu√™s',MT:'Matem√°tica',PROB:'Estat√≠stica',EN:'Ingl√™s',BC:'Conhec. Banc√°rios',AT:'Atualidades',RED:'Reda√ß√£o'};

// Presets de revis√£o espa√ßada (dias ap√≥s erro)
var REVISAO_PRESETS = {
  ebbinghaus: { dias: [1,7,16,35], label: 'Ebbinghaus Cl√°ssico', desc: 'Baseado na curva original de Ebbinghaus.' },
  concursos:  { dias: [1,3,7,14,30], label: 'Concursos', desc: 'Padr√£o cient√≠fico recomendado para concursos ‚Äî 5 revis√µes com espa√ßamento progressivo baseado na curva do esquecimento.' },
  intensivo:  { dias: [1,2,4,7,15], label: 'Intensivo', desc: 'Revis√µes mais pr√≥ximas ‚Äî ideal para prova chegando.' },
  relaxado:   { dias: [1,7,30], label: 'Leve', desc: 'Apenas 3 revis√µes, com espa√ßamento maior.' }
};

var currentPreset = 'concursos';
var REVISAO_DIAS = REVISAO_PRESETS.concursos.dias.slice();

var SEMANA_BASE = [
  {dia:"Segunda",manha:{mat:"TI",  pct:.54,badge:"badge-ti",label:"TI"},                     noite:{mat:"PT",   pct:.36,badge:"badge-pt",label:"Portugu√™s"}},
  {dia:"Ter√ßa",  manha:{mat:"MT",  pct:.45,badge:"badge-mt",label:"Matem√°tica"},              noite:{mat:"TI",   pct:.45,badge:"badge-ti",label:"TI"}},
  {dia:"Quarta", manha:{mat:"PT",  pct:.54,badge:"badge-pt",label:"Portugu√™s"},               noite:{mat:"PROB", pct:.36,badge:"badge-prob",label:"Prob./Estat."}},
  {dia:"Quinta", manha:{mat:"TI",  pct:.43,badge:"badge-ti",label:"TI"},                     noite:{mat:"EN",   pct:.29,badge:"badge-en",label:"Ingl√™s",mat2:"BC",pct2:.14,badge2:"badge-bc",label2:"Conhec. Banc√°rios"}},
  {dia:"Sexta",  manha:{mat:"MT",  pct:.45,badge:"badge-mt",label:"Matem√°tica"},              noite:{mat:"TI",   pct:.45,badge:"badge-ti",label:"TI"}},
  {dia:"S√°bado", manha:{mat:"TI",  pct:.54,badge:"badge-ti",label:"TI"},                     noite:{mat:"BC",   pct:.23,badge:"badge-bc",label:"Conhec. Banc√°rios",mat2:"AT",pct2:.12,badge2:"badge-at",label2:"Atualidades"}},
  {dia:"Domingo",manha:{mat:"RED", pct:.36,badge:"badge-red",label:"Reda√ß√£o"},                noite:{mat:"PT",   pct:.27,badge:"badge-pt",label:"Portugu√™s",mat2:"MT",pct2:.27,badge2:"badge-mt",label2:"Matem√°tica"}}
];

var DIAS_SEMANA = ['Segunda','Ter√ßa','Quarta','Quinta','Sexta','S√°bado','Domingo'];
var DIAS_SHORT  = ['Seg','Ter','Qua','Qui','Sex','S√°b','Dom'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var SK_PLAN     = 'plano_state_v6';
var SK_CE       = 'caderno_erros_v2';
var SK_SETTINGS = 'plano_settings_v3';

function saveData(key, val){
  try{
    var str = JSON.stringify(val);
    localStorage.setItem(key, str);
    localStorage.setItem(key+'__bk', str);
    showSaveOk();
  } catch(e){ console.warn('save error', e); }
}

function loadData(key, def){
  try{
    var r = localStorage.getItem(key);
    if(r) return JSON.parse(r);
    var bk = localStorage.getItem(key+'__bk');
    if(bk) return JSON.parse(bk);
    return def;
  } catch(e){
    try{
      var bk2 = localStorage.getItem(key+'__bk');
      if(bk2) return JSON.parse(bk2);
    } catch(e2){}
    return def;
  }
}

function showSaveOk(){
  ['save-ok','save-ok-sticky'].forEach(function(id){
    var el = document.getElementById(id);
    if(!el) return;
    el.classList.add('show');
    clearTimeout(el._t);
    el._t = setTimeout(function(){ el.classList.remove('show'); }, 2200);
  });
}

function buildFreshPlan(){
  return { pointers:{}, voltas:{}, acumulo:{}, diasFeitos:{} };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STICKY NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('scroll', function(){
  var nav = document.getElementById('sticky-nav');
  if(!nav) return;
  if(window.scrollY > 120) nav.classList.add('visible');
  else nav.classList.remove('visible');
}, {passive:true});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(name){
  document.querySelectorAll('.tab').forEach(function(t){ t.classList.remove('active'); });
  document.querySelectorAll('.tab-content').forEach(function(c){ c.classList.remove('active'); });
  var content = document.getElementById('tab-'+name);
  if(content) content.classList.add('active');
  document.querySelectorAll('.tab').forEach(function(t){
    var oc = t.getAttribute('onclick') || '';
    if(oc.indexOf("'"+name+"'") !== -1) t.classList.add('active');
  });
  if(name === 'caderno') renderCaderno();
  if(name === 'indice')  renderFullIndex();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PRESETS REVIS√ÉO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setPreset(name){
  currentPreset = name;
  REVISAO_DIAS = REVISAO_PRESETS[name].dias.slice();
  document.querySelectorAll('.rev-preset-btn').forEach(function(b){ b.classList.remove('active'); });
  var btn = document.getElementById('preset-'+name);
  if(btn) btn.classList.add('active');
  var desc = document.getElementById('preset-desc');
  if(desc) desc.textContent = REVISAO_PRESETS[name].desc;
  saveData(SK_SETTINGS, getSettings());
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUB-MAT√âRIA SELECTOR NO CADERNO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateSubMat(){
  var mat  = document.getElementById('ce-mat').value;
  var wrap = document.getElementById('sub-mat-wrap');
  var sel  = document.getElementById('ce-submat');
  if(!wrap || !sel) return;
  var data = TOPICOS_HIER[mat];
  if(!data){ wrap.classList.remove('visible'); return; }
  wrap.classList.add('visible');
  var opts = [{hier:'',nome:'‚Äî Selecionar subt√≥pico ‚Äî',depth:-1}];
  data.categories.forEach(function(cat){
    cat.items.forEach(function(item){
      if(item.depth <= 1) opts.push(item);
    });
  });
  sel.innerHTML = opts.map(function(o){
    var prefix = o.depth === 1 ? '  ‚Ü≥ ' : '';
    var qty = o.qty > 0 ? ' ('+o.qty+'q)' : '';
    return '<option value="'+(o.hier ? o.nome : '')+'">'+prefix+o.nome+qty+'</option>';
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// √çNDICE COMPLETO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderFullIndex(){
  var out = document.getElementById('indice-full');
  if(!out || out.dataset.rendered === '1') return;
  out.dataset.rendered = '1';
  var matOrder = [
    {key:'PT', label:'L√≠ngua Portuguesa', color:'var(--orange)'},
    {key:'MT', label:'Matem√°tica + Racioc√≠nio L√≥gico', color:'var(--green)'},
    {key:'TI', label:'Tecnologia da Informa√ß√£o', color:'var(--accent)'},
    {key:'PROB', label:'Estat√≠stica / Probabilidade', color:'var(--purple)'},
    {key:'EN', label:'L√≠ngua Inglesa', color:'var(--yellow)'},
    {key:'BC', label:'Conhecimentos Banc√°rios', color:'var(--orange)'},
    {key:'AT', label:'Atualidades do Mercado Financeiro', color:'var(--green)'},
    {key:'RED', label:'Reda√ß√£o', color:'var(--yellow)'}
  ];
  var html = '';
  matOrder.forEach(function(m){
    var key = m.key; var label = m.label; var color = m.color;
    var data = TOPICOS_HIER[key];
    if(!data) return;
    var totalQs = data.categories.reduce(function(s,c){ return s+c.qty; }, 0);
    var uid = 'fidx_'+key;
    html += '<div style="margin-bottom:12px;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--surface2)">'
      +'<button class="hier-toggle" onclick="toggleHier(\''+uid+'\')" id="btn_'+uid+'" style="padding:13px 16px">'
      +'<span class="ht-left">'
      +'<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:'+color+';flex-shrink:0"></span>'
      +'<span style="font-family:\'Syne\',sans-serif;font-size:13px;font-weight:700;color:var(--text);text-transform:none;letter-spacing:0">'+label+'</span>'
      +'</span>'
      +'<span style="display:flex;align-items:center;gap:10px">'
      +(totalQs>0 ? '<span style="font-size:10px;color:var(--green)">'+totalQs+' quest√µes</span>' : '<span style="font-size:10px;color:var(--muted)">pr√°tica</span>')
      +'<span class="ht-arrow">‚Ä∫</span>'
      +'</span>'
      +'</button>'
      +'<div class="hier-body" id="'+uid+'">';
    data.categories.forEach(function(cat, ci){
      var catUid = uid+'_c'+ci;
      html += '<div class="hier-cat">'
        +'<div class="hier-cat-hdr" onclick="toggleHierCat(\''+catUid+'\')" id="btn_'+catUid+'">'
        +'<span class="hc-arr">‚Ä∫</span>'
        +'<span class="hc-name">'+cat.nome+'</span>'
        +'<span class="hc-qty">'+(cat.qty>0 ? cat.qty+' quest√µes' : 'pr√°tica')+'</span>'
        +'</div>'
        +'<div class="hier-cat-body" id="'+catUid+'">';
      cat.items.forEach(function(item){
        var indent = item.depth * 14;
        html += '<div class="hier-item" data-depth="'+item.depth+'" style="padding-left:'+(13+indent)+'px">'
          +'<span class="hi-code" style="padding-left:0;min-width:'+(40+indent)+'px">'+item.hier+'</span>'
          +'<span class="hi-name">'+item.nome+'</span>'
          +(item.qty>0 ? '<span class="hi-qty">'+item.qty+'q</span>' : '')
          +'</div>';
      });
      html += '</div></div>';
    });
    html += '</div></div>';
  });
  out.innerHTML = html;
}

function toggleHier(uid){
  var body = document.getElementById(uid);
  var btn  = document.getElementById('btn_'+uid);
  if(!body || !btn) return;
  var isOpen = body.classList.contains('open');
  body.classList.toggle('open');
  btn.classList.toggle('open');
  var arrow = btn.querySelector('.ht-arrow');
  if(arrow) arrow.style.transform = isOpen ? '' : 'rotate(90deg)';
}
function toggleHierCat(uid){
  var body = document.getElementById(uid);
  var btn  = document.getElementById('btn_'+uid);
  if(!body || !btn) return;
  body.classList.toggle('open');
  btn.classList.toggle('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SETTINGS / RANGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function syncRange(id, valId){
  var el  = document.getElementById(valId);
  var src = document.getElementById(id);
  if(el && src) el.textContent = src.value;
  saveSettings();
}
function saveSettings(){ saveData(SK_SETTINGS, getSettings()); }
function getSettings(){
  return {
    dataInicio: document.getElementById('data-inicio').value,
    duracao:    parseInt(document.getElementById('duracao-meses').value) || 3,
    qph:        parseInt(document.getElementById('qph').value) || 15,
    nivel:      parseFloat(document.getElementById('nivel').value) || 1.0,
    dayHours:   getDayHours(),
    preset:     currentPreset
  };
}
function getDayHours(){
  var h = {};
  DIAS_SEMANA.forEach(function(d, i){
    var sl = document.getElementById('dh-range-'+i);
    h[d] = sl ? parseFloat(sl.value) : (DEFAULT_HOURS[d] || 5);
  });
  return h;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DAY HOURS SLIDERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var DEFAULT_HOURS = {Segunda:5.5, Ter√ßa:5.5, Quarta:5.5, Quinta:6.5, Sexta:5.5, S√°bado:5.5, Domingo:5.5};
function buildDayHoursGrid(saved){
  var grid = document.getElementById('day-hours-grid');
  if(!grid) return;
  grid.innerHTML = '';
  DIAS_SEMANA.forEach(function(dia, i){
    var val = (saved && saved[dia] !== undefined) ? saved[dia] : DEFAULT_HOURS[dia];
    var isFolga = val === 0;
    var div = document.createElement('div');
    div.className = 'dh' + (isFolga ? ' folga' : '');
    div.id = 'dh-card-'+i;
    div.innerHTML = '<div class="dh-name">'+DIAS_SHORT[i]+'</div>'
      +'<input type="range" id="dh-range-'+i+'" min="0" max="12" step="0.5" value="'+val+'"'
      +' oninput="updateDhCard('+i+')" style="width:100%;margin-bottom:6px">'
      +'<div class="dh-val" id="dh-val-'+i+'">'+(isFolga ? '‚Äî' : val+'h')+'</div>'
      +'<div class="dh-sub" id="dh-sub-'+i+'">'+(isFolga ? 'folga' : formatHorasMin(val))+'</div>'
      +'<button class="dh-toggle" id="dh-toggle-'+i+'" onclick="toggleFolga('+i+')">'+(isFolga ? 'Ativar' : 'Folga')+'</button>';
    grid.appendChild(div);
  });
}
function updateDhCard(i){
  var sl = document.getElementById('dh-range-'+i);
  if(!sl) return;
  var val = parseFloat(sl.value);
  var isFolga = val === 0;
  document.getElementById('dh-val-'+i).textContent    = isFolga ? '‚Äî' : val+'h';
  document.getElementById('dh-sub-'+i).textContent    = isFolga ? 'folga' : formatHorasMin(val);
  document.getElementById('dh-toggle-'+i).textContent = isFolga ? 'Ativar' : 'Folga';
  document.getElementById('dh-card-'+i).className     = 'dh' + (isFolga ? ' folga' : '');
  saveSettings();
}
function toggleFolga(i){
  var sl = document.getElementById('dh-range-'+i);
  if(!sl) return;
  var cur = parseFloat(sl.value);
  sl.value = cur === 0 ? (DEFAULT_HOURS[DIAS_SEMANA[i]] || 5) : 0;
  updateDhCard(i);
}
function formatHorasMin(h){
  if(!h || h === 0) return 'folga';
  var hrs = Math.floor(h);
  var min = Math.round((h - hrs) * 60);
  if(hrs > 0 && min > 0) return hrs+'h '+min+'min';
  if(hrs > 0)            return hrs+'h';
  return min+'min';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOGGLE SEMANA (accordion)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleSemana(weekId){
  var body = document.getElementById('week-body-'+weekId);
  var hdr  = document.getElementById('week-hdr-'+weekId);
  if(!body || !hdr) return;
  body.classList.toggle('open');
  hdr.classList.toggle('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOGGLE DIA (accordion) ‚Äî FIXED
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleDia(cardStr){
  var body = document.getElementById('dayb-'+cardStr);
  var hdr  = document.getElementById('dayh-'+cardStr);
  if(!body || !hdr) return;
  var isCurrentlyOpen = hdr.classList.contains('open');
  if(isCurrentlyOpen){
    body.style.display = 'none';
    hdr.classList.remove('open');
  } else {
    body.style.display = 'block';
    hdr.classList.add('open');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APPLY SESSIONS (pure state mutation, no HTML render)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applySessionsToState(manha, noite, manhaH, noiteH, noite2H, qsHora, state){
  applySessionToState(manha, manhaH, qsHora, state);
  applySessionToState(noite, noiteH, qsHora, state);
  if(noite.mat2 && noite2H > 0.05){
    var sess2 = {mat: noite.mat2, badge: noite.badge2, label: noite.label2};
    applySessionToState(sess2, noite2H, qsHora, state);
  }
}

function applySessionToState(sess, horas, qsHora, state){
  if(horas < 0.05) return;
  getTopicos(sess.mat, horas, qsHora, state); // mutates state, discard return
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GERAR PLANO ‚Äî FIXED: skip completed days in workState
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function gerarPlano(){
  var settings = getSettings();
  saveSettings();
  if(!settings.dataInicio){ alert('Por favor selecione uma data de in√≠cio.'); return; }
  var qsHora = Math.max(1, parseInt(settings.qph));
  var inicio = new Date(settings.dataInicio + 'T12:00:00');
  var fim    = new Date(inicio);
  fim.setMonth(fim.getMonth() + settings.duracao);
  var totalDias    = Math.round((fim - inicio) / (1000*60*60*24));
  var totalSemanas = Math.ceil(totalDias / 7);
  var totalHorasSemana = Object.values(settings.dayHours).reduce(function(a,v){ return a+v; }, 0);

  document.getElementById('pills').style.display = 'flex';
  document.getElementById('p-ritmo').textContent  = qsHora+' qs/h';
  document.getElementById('p-qsem').textContent   = '~'+Math.round(qsHora * totalHorasSemana);
  document.getElementById('p-sem').textContent    = totalSemanas;
  document.getElementById('p-total').textContent  = Object.values(TOTAIS).reduce(function(a,v){ return a+v; }, 0);
  document.getElementById('p-periodo').textContent = fmtDate(inicio)+' ‚Üí '+fmtDate(fim);

  // FIX: Load saved state. savedState.pointers/voltas/acumulo already reflect all completed days.
  // We must NOT re-advance state for completed days ‚Äî just render them as done.
  var savedState = loadData(SK_PLAN, buildFreshPlan());
  if(!savedState.pointers)   savedState.pointers   = {};
  if(!savedState.voltas)     savedState.voltas     = {};
  if(!savedState.acumulo)    savedState.acumulo    = {};
  if(!savedState.diasFeitos) savedState.diasFeitos = {};

  // workState starts from the current saved progress
  var workState = {
    pointers: deepClone(savedState.pointers),
    voltas:   deepClone(savedState.voltas),
    acumulo:  deepClone(savedState.acumulo)
  };

  if(!window._dayData) window._dayData = {};
  // Clear old day data to avoid stale entries
  window._dayData = {};

  var ceData = loadData(SK_CE, []);
  var todayStr = dateStr(new Date());

  var html = '';
  var inicioDay = inicio.getDay();
  var daysToMon = inicioDay === 0 ? -6 : 1 - inicioDay;
  var currentDate = new Date(inicio);
  currentDate.setDate(currentDate.getDate() + daysToMon);

  for(var weekNum = 0; weekNum < totalSemanas; weekNum++){
    var weekStart = new Date(currentDate);
    var weekEnd   = new Date(currentDate);
    weekEnd.setDate(weekEnd.getDate() + 6);

    var weekStartStr = dateStr(weekStart);
    var weekEndStr   = dateStr(weekEnd);
    var weekHasToday = todayStr >= weekStartStr && todayStr <= weekEndStr;
    var weekQs = 0;

    var weekId = 'wk'+weekNum;
    var weekOpen = weekHasToday;

    html += '<div class="cycle-section">'
      +'<div class="cycle-hdr '+(weekOpen?'open':'')+'" id="week-hdr-'+weekId+'" onclick="toggleSemana(\''+weekId+'\')">'
      +'<div class="cycle-hdr-left">'
      +'<span class="cycle-badge">Semana '+(weekNum+1)+'</span>'
      +'<span class="cycle-dates">'+fmtDate(weekStart)+' ‚Äì '+fmtDate(weekEnd)+'</span>'
      +'</div>'
      +'<div class="cycle-stats-mini"><span class="csm-item">~<b id="wqs-'+weekId+'">...</b> quest√µes</span></div>'
      +'<span class="cycle-arrow">‚Ä∫</span>'
      +'</div>'
      +'<div class="cycle-body '+(weekOpen?'open':'')+'" id="week-body-'+weekId+'">'
      +'<div class="days-grid">';

    for(var di = 0; di < 7; di++){
      var cardDate = new Date(currentDate);
      cardDate.setDate(cardDate.getDate() + di);
      var jsDay   = cardDate.getDay();
      var baseIdx = jsDay === 0 ? 6 : jsDay - 1;
      var diaBase = SEMANA_BASE[baseIdx];
      var sliderEl = document.getElementById('dh-range-'+baseIdx);
      var totalH   = sliderEl ? parseFloat(sliderEl.value) : (DEFAULT_HOURS[DIAS_SEMANA[baseIdx]] || 5);
      var isFolga  = totalH === 0;
      var cardStr  = dateStr(cardDate);
      var isToday  = cardStr === todayStr;
      var dateLabel = fmtDateCard(cardDate);
      var revisoesDoDia = getRevisoesDoDia(ceData, cardDate);

      var revBlock = revisoesDoDia.length > 0
        ? '<div class="rev-chips">'+revisoesDoDia.map(function(r){
            var cls = cardStr < todayStr ? 'overdue-chip' : isToday ? 'today-chip' : 'normal';
            return '<span class="rev-chip '+cls+'">'+r.mat+'<span style="opacity:.6;font-size:9px"> ¬∑ rev.'+r.stepLabel+'</span></span>';
          }).join('')+'</div>'
        : '<div class="rev-empty">Sem revis√µes</div>';

      if(isFolga){
        html += '<div class="day-card folga-card'+(isToday?' today-card':'') + '">'
          +'<div class="day-hdr-row" onclick="toggleDia(\''+cardStr+'\')" id="dayh-'+cardStr+'">'
          +'<div class="day-info">'
          +'<div class="day-name">'+dateLabel+(isToday ? '<span class="today-chip-hdr">hoje</span>' : '')+'</div>'
          +'<div class="day-load"><b>Folga</b></div>'
          +'</div>'
          +'<div class="day-reviews-col">'+revBlock+'</div>'
          +'<div class="day-arrow-col"><span class="day-arrow">‚Ä∫</span></div>'
          +'</div>'
          +'<div style="display:none" id="dayb-'+cardStr+'">'
          +'<div class="folga-msg">üåô Dia de descanso</div>'
          +'</div>'
          +'</div>';
        continue;
      }

      var revMin = revisoesDoDia.length > 0 ? 35 : 0;
      var horasEstudo = Math.max(0, totalH - (revMin/60));
      var manha = diaBase.manha;
      var noite = diaBase.noite;
      var totalPct = manha.pct + (noite.pct || 0) + (noite.pct2 || 0);
      var manhaH   = horasEstudo * manha.pct / totalPct;
      var noiteH   = horasEstudo * (noite.pct || 0) / totalPct;
      var noite2H  = noite.pct2 ? horasEstudo * noite.pct2 / totalPct : 0;

      var jaFeito = !!savedState.diasFeitos[cardStr];

      if(jaFeito){
        // FIX: Day already completed ‚Äî state was already advanced when it was marked done.
        // Just render the stored day snapshot without re-advancing workState.
        // Save a reference so concluirDia / desfazerDia can still work.
        var doneSnap = {
          pointers: deepClone(workState.pointers),
          voltas:   deepClone(workState.voltas),
          acumulo:  deepClone(workState.acumulo)
        };
        window._dayData[cardStr] = {
          snap: doneSnap,
          manha: manha, noite: noite,
          manhaH: manhaH, noiteH: noiteH, noite2H: noite2H,
          qsHora: qsHora
        };

        var dayOpen = isToday;
        html += '<div class="day-card done-card'+(isToday?' today-card':'')+'" id="card-'+cardStr+'">'
          +'<div class="day-hdr-row'+(dayOpen?' open':'')+'" onclick="toggleDia(\''+cardStr+'\')" id="dayh-'+cardStr+'">'
          +'<div class="day-info">'
          +'<div class="day-name">'+dateLabel+(isToday ? '<span class="today-chip-hdr">hoje</span>' : '')+'</div>'
          +'<div class="day-load"><b>'+formatHorasMin(totalH)+'</b>'+(revMin>0 ? '<span class="day-load-rev">¬∑ +35min rev.</span>' : '')+'</div>'
          +'</div>'
          +'<div class="day-reviews-col">'
          +'<div class="rev-label">üìì Caderno'+(revisoesDoDia.length>0 ? ' <span style="color:var(--green);font-weight:700">('+revisoesDoDia.length+')</span>' : '')+'</div>'
          +revBlock
          +'</div>'
          +'<div class="day-arrow-col"><span class="day-arrow">‚Ä∫</span></div>'
          +'</div>'
          +'<div id="dayb-'+cardStr+'" style="'+(dayOpen ? '' : 'display:none')+'">'
          +'<div class="day-footer">'
          +'<div class="done-banner">‚úÖ Dia conclu√≠do</div>'
          +'<button class="btn-desfazer" onclick="desfazerDia(\''+cardStr+'\')">‚Ü© Desfazer</button>'
          +'</div>'
          +'</div>'
          +'</div>';
        continue;
      }

      // Future/today day ‚Äî render with current workState
      var s1 = renderSessao(manha, manhaH, qsHora, workState);
      var s2 = renderSessaoNoite(noite, noiteH, noite2H, qsHora, workState);
      weekQs += s1.qs + s2.qs;

      // Save snapshot of state AFTER sessions were applied (for concluirDia to use)
      var todaySnap = {
        pointers: deepClone(workState.pointers),
        voltas:   deepClone(workState.voltas),
        acumulo:  deepClone(workState.acumulo)
      };
      window._dayData[cardStr] = {
        snap: todaySnap,
        manha: manha, noite: noite,
        manhaH: manhaH, noiteH: noiteH, noite2H: noite2H,
        qsHora: qsHora
      };

      var dayOpen2 = isToday;

      var footerHtml;
      if(!isToday && cardStr > todayStr){
        footerHtml = '<div class="day-footer">'
          +'<div class="day-qs-info">üìã <b>~'+(s1.qs+s2.qs)+'</b> quest√µes</div>'
          +'<span style="font-size:10px;color:var(--muted2)">Dispon√≠vel na data</span>'
          +'</div>';
      } else {
        footerHtml = '<div class="day-footer">'
          +'<div class="day-qs-info">üìã <b>~'+(s1.qs+s2.qs)+'</b> quest√µes planejadas</div>'
          +'<button class="btn-concluir" onclick="concluirDia(\''+cardStr+'\')">‚úì Concluir Dia</button>'
          +'</div>';
      }

      html += '<div class="day-card'+(isToday?' today-card':'')+'" id="card-'+cardStr+'">'
        +'<div class="day-hdr-row'+(dayOpen2?' open':'')+'" onclick="toggleDia(\''+cardStr+'\')" id="dayh-'+cardStr+'">'
        +'<div class="day-info">'
        +'<div class="day-name">'+dateLabel+(isToday ? '<span class="today-chip-hdr">hoje</span>' : '')+'</div>'
        +'<div class="day-load"><b>'+formatHorasMin(totalH)+'</b>'+(revMin>0 ? '<span class="day-load-rev">¬∑ +35min rev.</span>' : '')+'</div>'
        +'</div>'
        +'<div class="day-reviews-col">'
        +'<div class="rev-label">üìì Caderno'+(revisoesDoDia.length>0 ? ' <span style="color:var(--green);font-weight:700">('+revisoesDoDia.length+')</span>' : '')+'</div>'
        +revBlock
        +'</div>'
        +'<div class="day-arrow-col"><span class="day-arrow">‚Ä∫</span></div>'
        +'</div>'
        +'<div id="dayb-'+cardStr+'" style="'+(dayOpen2 ? '' : 'display:none')+'">'
        +'<div class="day-body">'
        +'<div class="session manha">'
        +'<div class="sess-label">Manh√£ / Tarde ¬∑ '+formatHorasMin(manhaH)+'</div>'
        +s1.html
        +'</div>'
        +'<div class="session noite">'
        +'<div class="sess-label">Noite ¬∑ '+formatHorasMin(noiteH+noite2H)+'</div>'
        +s2.html
        +'</div>'
        +'</div>'
        +footerHtml
        +'</div>'
        +'</div>';
    }

    // Update week qs stat (approximate based on accumulated weekQs for non-done days)
    html += '</div>'
      +'<div class="cycle-footer">'
      +'<div class="stat-item"><div class="stat-val">'+qsHora+'</div><div class="stat-lbl">Qs/hora</div></div>'
      +'<div class="stat-item"><div class="stat-val">~'+weekQs+'</div><div class="stat-lbl">Qs/semana</div></div>'
      +'<div class="stat-item"><div class="stat-val">'+formatHorasMin(totalHorasSemana)+'</div><div class="stat-lbl">Carga semanal</div></div>'
      +'<div class="stat-item"><div class="stat-val">'+(weekNum+1)+'/'+totalSemanas+'</div><div class="stat-lbl">Semana</div></div>'
      +'</div>'
      +'</div></div>';

    currentDate.setDate(currentDate.getDate() + 7);
  }

  html += '<div class="note">'
    +'<b>Como funciona:</b> Cada sess√£o avan√ßa pelos t√≥picos conforme a carga hor√°ria. '
    +'Ao terminar todos os t√≥picos de uma mat√©ria, ela <b style="color:var(--purple)">reinicia em nova volta üîÑ</b>. '
    +'Quest√µes n√£o conclu√≠das s√£o <b style="color:var(--yellow)">acumuladas (+N acum.)</b> e somadas na pr√≥xima vez. '
    +'As revis√µes do <b style="color:var(--yellow)">Caderno de Erros</b> aparecem automaticamente em cada dia.'
    +'</div>';

  document.getElementById('plano-output').innerHTML = html;
  renderProgressOverview(savedState);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER SESS√ÉO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSessao(sess, horas, qsHora, state){
  if(horas < 0.05) return {html:'<span style="font-size:11px;color:var(--muted2)">‚Äî</span>', qs:0};
  var isRedacao = sess.mat === 'RED';
  var r = getTopicos(sess.mat, horas, qsHora, state);
  var html = '<div class="sess-mat">'+sess.label+' <span class="mbadge '+sess.badge+'">'+sess.mat+'</span>';
  if((state.voltas[sess.mat]||1) > 1) html += ' <span class="volta-chip">'+(state.voltas[sess.mat])+'¬™ volta</span>';
  html += '</div>';
  if(r.restartOccurred) html += '<div class="restart-banner">üîÑ Nova volta em '+sess.mat+' iniciada!</div>';
  html += renderTopicsList(r.items, isRedacao);
  if(!isRedacao) html += renderHierIndex(sess.mat, r.items, state);
  return {html: html, qs: r.items.reduce(function(s,t){ return s+(t.qsFeitos||0); }, 0)};
}

function renderSessaoNoite(noite, noiteH, noite2H, qsHora, state){
  var html = '', qs = 0;
  var r1 = renderSessao(noite, noiteH, qsHora, state);
  html += r1.html; qs += r1.qs;
  if(noite.mat2 && noite2H > 0.05){
    html += '<hr class="divider">';
    var sess2 = {mat: noite.mat2, badge: noite.badge2, label: noite.label2};
    var r2 = renderSessao(sess2, noite2H, qsHora, state);
    html += r2.html; qs += r2.qs;
  }
  return {html: html, qs: qs};
}

function renderTopicsList(lista, isRedacao){
  if(!lista || lista.length === 0) return '<div style="font-size:12px;color:var(--green)">‚úì Sess√£o coberta!</div>';
  return '<ul class="topics">'+lista.map(function(t){
    var stag   = t.size==='g' ? 'stag-g' : t.size==='m' ? 'stag-m' : 'stag-p';
    var slabel = t.size==='g' ? 'GRANDE'  : t.size==='m' ? 'M√âDIO'  : 'PEQUENO';
    var cls    = t.completo ? 'is-completo' : t.parcial ? 'is-parcial' : '';
    var statusTag = t.parcial
      ? '<em style="font-size:10px;color:var(--yellow);font-style:normal;font-weight:400">(continua...)</em>'
      : t.completo ? '<em style="font-size:10px;color:var(--green);font-style:normal;font-weight:400">‚úì completo</em>' : '';
    var acumBadge = (t.qsAcumuladas && t.qsAcumuladas > 0)
      ? '<span class="acum-badge">+'+t.qsAcumuladas+' acum.</span>' : '';
    var metaHtml;
    if(isRedacao){
      var minutos = Math.round(t.hUsed * 60);
      metaHtml = '<div class="t-meta"><span class="t-h">~'+minutos+'min de pr√°tica</span></div>';
    } else {
      var pct = t.qty > 0 ? Math.min(100, Math.round((t.qsFeitos / t.qty)*100)) : 0;
      var totalComAcum = t.qty + (t.qsAcumuladas || 0);
      metaHtml = '<div class="t-meta">'
        +'<span class="t-qs">~'+t.qsFeitos+' quest√µes</span>'
        +'<span class="t-total">de '+totalComAcum+' total'+(t.qsAcumuladas>0 ? ' ('+t.qty+' banco+'+t.qsAcumuladas+'‚Ü∫)':'')+'</span>'
        +'<span class="t-h">'+formatHorasMin(t.hUsed)+'</span>'
        +'</div>'
        +'<div class="t-bar"><div class="t-fill" style="width:'+pct+'%"></div></div>';
    }
    return '<li class="'+cls+'">'
      +'<div class="t-nome">'
      +'<span class="stag '+stag+'">'+slabel+'</span>'
      +t.nome+acumBadge
      +statusTag
      +'</div>'
      +metaHtml
      +'</li>';
  }).join('')+'</ul>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// √çNDICE HIER√ÅRQUICO DA SESS√ÉO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHierIndex(mat, sessionItems, state){
  var data = TOPICOS_HIER[mat];
  if(!data) return '';
  var capMap = {};
  (sessionItems || []).forEach(function(t){
    capMap[t.nome] = {qsFeitos: t.qsFeitos||0, qsAcumuladas: t.qsAcumuladas||0};
  });
  if(Object.keys(capMap).length === 0) return '';

  var uid = 'hier_'+mat+'_'+Math.random().toString(36).slice(2,7);
  var catHtml = '';

  data.categories.forEach(function(cat, ci){
    var capsNaSessao = cat.items.filter(function(it){ return it.depth===0 && capMap[it.nome]; });
    if(capsNaSessao.length === 0) return;
    var catUid = uid+'_c'+ci;
    var itensHtml = '';

    capsNaSessao.forEach(function(cap){
      var sessInfo = capMap[cap.nome];
      var qsSessao = sessInfo.qsFeitos;
      var qsAcum   = sessInfo.qsAcumuladas;
      var hierPrefix = cap.hier+'.';
      var subItens = cat.items.filter(function(it){ return it.hier===cap.hier || it.hier.startsWith(hierPrefix); });

      // CORRECT LOGIC: each subitem shows min(its_bank_qty, remaining_budget).
      // We walk depth=1 items in order, consuming the session budget.
      // depth=2/3 items are children of depth=1 ‚Äî they consume from their parent's allocation.
      // This matches reality: "you have 30q to do, 01.01 has 3 in bank ‚Üí do all 3,
      // 01.02 has 11 ‚Üí do all 11, 01.03 has 20 ‚Üí do all 20. Total = 34 but session = 30,
      // so the last topic gets capped at what's left."

      var hierSessMap = {};
      hierSessMap[cap.hier] = {sessQs: qsSessao, acumQs: qsAcum};

      // Allocate to depth=1 items in order ‚Äî each gets min(qty, remaining)
      var d1items = subItens.filter(function(it){ return it.depth===1; });
      var remainingSess = qsSessao;
      var remainingAcum = qsAcum;
      d1items.forEach(function(it){
        var give = Math.min(it.qty, remainingSess);
        var giveAcum = remainingSess > 0 ? Math.round(remainingAcum * give / remainingSess) : 0;
        hierSessMap[it.hier] = {sessQs: give, acumQs: giveAcum};
        remainingSess -= give;
        remainingAcum = Math.max(0, remainingAcum - giveAcum);
      });

      // depth=2: within each depth=1 parent, allocate to children in order
      d1items.forEach(function(d1){
        var d2items = subItens.filter(function(it){ return it.depth===2 && it.hier.startsWith(d1.hier+'.'); });
        if(d2items.length === 0) return;
        var parentAlloc = hierSessMap[d1.hier] || {sessQs:0, acumQs:0};
        var rem2 = parentAlloc.sessQs;
        var remA2 = parentAlloc.acumQs;
        d2items.forEach(function(it){
          var give = Math.min(it.qty, rem2);
          var giveAcum = rem2 > 0 ? Math.round(remA2 * give / rem2) : 0;
          hierSessMap[it.hier] = {sessQs: give, acumQs: giveAcum};
          rem2 -= give;
          remA2 = Math.max(0, remA2 - giveAcum);
        });
      });

      // depth=3: within each depth=2 parent, allocate to children in order
      var d2items_all = subItens.filter(function(it){ return it.depth===2; });
      d2items_all.forEach(function(d2){
        var d3items = subItens.filter(function(it){ return it.depth===3 && it.hier.startsWith(d2.hier+'.'); });
        if(d3items.length === 0) return;
        var parentAlloc = hierSessMap[d2.hier] || {sessQs:0, acumQs:0};
        var rem3 = parentAlloc.sessQs;
        var remA3 = parentAlloc.acumQs;
        d3items.forEach(function(it){
          var give = Math.min(it.qty, rem3);
          var giveAcum = rem3 > 0 ? Math.round(remA3 * give / rem3) : 0;
          hierSessMap[it.hier] = {sessQs: give, acumQs: giveAcum};
          rem3 -= give;
          remA3 = Math.max(0, remA3 - giveAcum);
        });
      });

      subItens.forEach(function(item){
        var indent  = item.depth * 14;
        var isMain  = item.depth === 0;
        var entry   = hierSessMap[item.hier] || {sessQs:0, acumQs:0};
        var sessQsItem = entry.sessQs;
        var acumQsItem = entry.acumQs;

        var bgStyle   = isMain ? 'background:rgba(79,126,245,.04);border-bottom:1px solid var(--border2);margin-bottom:1px;' : '';
        var codeStyle = isMain ? 'color:var(--accent);opacity:1;' : '';
        var nameStyle = isMain ? 'color:var(--text);font-weight:600;' : '';
        var sessQsBadge = sessQsItem>0 ? '<span class="hi-sess-qs">‚ú¶'+sessQsItem+'q</span>' : '';
        var acumQsBadge = acumQsItem>0 ? '<span class="hi-acum-qs">+'+acumQsItem+'‚Ü∫</span>' : '';
        itensHtml += '<div class="hier-item" data-depth="'+item.depth+'" style="padding-left:'+(13+indent)+'px;'+bgStyle+'">'
          +'<span class="hi-code" style="padding-left:0;min-width:'+(40+indent)+'px;'+codeStyle+'">'+item.hier+'</span>'
          +'<span class="hi-name" style="'+nameStyle+'">'+item.nome+'</span>'
          +sessQsBadge+acumQsBadge
          +'<span class="hi-qty" style="margin-left:4px">'+(item.qty>0 ? item.qty+'q banco' : '')+'</span>'
          +'</div>';
      });
    });

    catHtml += '<div class="hier-cat">'
      +'<div class="hier-cat-hdr" onclick="toggleHierCat(\''+catUid+'\')" id="btn_'+catUid+'">'
      +'<span class="hc-arr">‚Ä∫</span>'
      +'<span class="hc-name">'+cat.nome+'</span>'
      +'<span class="hc-qty" style="color:var(--yellow)">'+capsNaSessao.length+' t√≥pico'+(capsNaSessao.length>1?'s':'') +' hoje</span>'
      +'</div>'
      +'<div class="hier-cat-body" id="'+catUid+'">'+itensHtml+'</div>'
      +'</div>';
  });

  if(!catHtml) return '';

  return '<div class="hier-wrap">'
    +'<button class="hier-toggle" onclick="toggleHier(\''+uid+'\')" id="btn_'+uid+'">'
    +'<span class="ht-left"><span style="font-size:11px">üìã</span><span>√çndice de hoje</span></span>'
    +'<span style="display:flex;align-items:center;gap:8px">'
    +'<span style="font-size:10px;color:var(--green)">'+Object.keys(capMap).length+' t√≥pico'+(Object.keys(capMap).length>1?'s':'')+'</span>'
    +'<span style="font-size:10px;color:var(--yellow)">‚ú¶ = qs da sess√£o</span>'
    +'<span class="ht-arrow">‚Ä∫</span>'
    +'</span>'
    +'</button>'
    +'<div class="hier-body" id="'+uid+'">'+catHtml+'</div>'
    +'</div>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// T√ìPICOS ‚Äî L√ìGICA (FIXED: partial topic pointer advancement)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getTopicos(mat, horas, qsHora, state){
  var lista = TOPICOS[mat];
  if(!lista || lista.length === 0) return {items:[], restartOccurred:false};
  if(state.pointers[mat] === undefined) state.pointers[mat] = 0;
  if(state.voltas[mat]   === undefined) state.voltas[mat]   = 1;
  if(!state.acumulo) state.acumulo = {};

  var isRedacao = mat === 'RED';
  var hLeft = horas, out = [], idx = state.pointers[mat], restartOccurred = false;
  var safety = lista.length * 4 + 20;

  while(hLeft > 0.08 && safety-- > 0){
    if(idx >= lista.length){
      idx = 0;
      state.pointers[mat] = 0;
      state.voltas[mat] = (state.voltas[mat] || 1) + 1;
      restartOccurred = true;
    }
    var t = lista[idx];
    if(isRedacao){
      out.push({id:t.id, nome:t.nome, qty:0, size:t.size, hUsed: +hLeft.toFixed(2), qsFeitos:0, completo:true, qsAcumuladas:0});
      hLeft = 0;
      idx++;
    } else {
      var acumKey  = mat+'__'+t.nome;
      var qsAcum   = Math.max(0, state.acumulo[acumKey] || 0);
      var qsTotal  = t.qty + qsAcum;
      var hT = Math.max(0.1, qsTotal / Math.max(1, qsHora));

      if(hLeft >= hT * 0.4){
        var hU       = Math.min(hT, hLeft);
        var qsFeitos = Math.round(hU * qsHora);
        var completo = hU >= hT * 0.88;
        if(completo){
          state.acumulo[acumKey] = 0;
          // FIX: Only advance pointer when topic is fully completed
          idx++;
        } else {
          // Partial: save remaining and keep same topic for next session
          var qsBancoFeitos = Math.min(t.qty, qsFeitos);
          var restanteBanco = Math.max(0, t.qty - qsBancoFeitos);
          state.acumulo[acumKey] = restanteBanco;
          // Do NOT advance idx ‚Äî topic continues next session
        }
        out.push({id:t.id, nome:t.nome, qty:t.qty, size:t.size, hUsed:+hU.toFixed(2), qsFeitos:qsFeitos, completo:completo, parcial:!completo, qsAcumuladas:qsAcum, qsTotal:qsTotal});
        hLeft -= hU;
      } else {
        // Not enough time even for 40% of topic ‚Äî take what's available
        if(out.length === 0){
          var qsFeitos2 = Math.round(hLeft * qsHora);
          var qsBancoFeitos2 = Math.min(t.qty, qsFeitos2);
          var restanteBanco2 = Math.max(0, t.qty - qsBancoFeitos2);
          state.acumulo[acumKey] = restanteBanco2;
          out.push({id:t.id, nome:t.nome, qty:t.qty, size:t.size, hUsed:+hLeft.toFixed(2), qsFeitos:qsFeitos2, completo:false, parcial:true, qsAcumuladas:qsAcum, qsTotal:qsTotal});
        }
        break;
      }
    }
  }
  state.pointers[mat] = idx;
  return {items: out, restartOccurred: restartOccurred};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROGRESS OVERVIEW ‚Äî FIXED: uses savedState correctly
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderProgressOverview(savedState){
  var panel = document.getElementById('progress-panel');
  var grid  = document.getElementById('mat-grid');
  if(!panel || !grid) return;
  panel.style.display = 'block';

  var settings = getSettings();
  var qsHora = Math.max(1, parseInt(settings.qph));
  var ceData = loadData(SK_CE, []);
  var today  = dateStr(new Date());

  grid.innerHTML = Object.keys(TOPICOS).map(function(mat){
    var lista = TOPICOS[mat];
    if(!lista || lista.length === 0) return '';
    var isRedacao = mat === 'RED';
    var ptr   = savedState.pointers[mat] || 0;
    var volta = savedState.voltas[mat]   || 1;
    var cor   = MAT_COLORS[mat] || 'var(--accent)';
    var label = MAT_LABELS[mat] || mat;

    var totalAcum = !savedState.acumulo ? 0 : Object.keys(savedState.acumulo)
      .filter(function(k){ return k.startsWith(mat+'__'); })
      .reduce(function(s,k){ return s + (savedState.acumulo[k]||0); }, 0);

    var errosAtivos    = ceData.filter(function(e){ return e.mat === mat && e.steps.some(function(s){ return !s.done; }); }).length;
    var errosPendentes = ceData.filter(function(e){ return e.mat === mat && e.steps.some(function(s){ return !s.done && s.date <= today; }); }).length;

    if(isRedacao){
      var pct = lista.length > 0 ? Math.round((ptr / lista.length)*100) : 0;
      var restantes = lista.length - ptr;
      var proximoTopico = lista[ptr] ? lista[ptr].nome : null;
      return '<div class="mat-card">'
        +'<div class="mat-top">'
        +'<span class="mat-name" style="color:'+cor+'">'+label+'</span>'
        +(volta>1 ? '<span class="volta-chip">'+volta+'¬™ volta</span>' : '')
        +'</div>'
        +'<div style="display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-bottom:4px">'
        +'<span>'+ptr+'/'+lista.length+' pr√°ticas</span>'
        +'<span style="color:'+cor+';font-weight:700">'+pct+'%</span>'
        +'</div>'
        +'<div class="mini-bar"><div class="mini-fill" style="width:'+pct+'%;background:'+cor+'"></div></div>'
        +'<div class="mat-stats-row">'
        +'<div class="mat-stat"><div class="mat-stat-val" style="color:'+cor+'">'+ptr+'</div><div class="mat-stat-lbl">Feitas</div></div>'
        +'<div class="mat-stat"><div class="mat-stat-val" style="color:var(--muted)">'+restantes+'</div><div class="mat-stat-lbl">Restam</div></div>'
        +'<div class="mat-stat"><div class="mat-stat-val" style="color:var(--purple)">'+volta+'</div><div class="mat-stat-lbl">Volta</div></div>'
        +'</div>'
        +(proximoTopico ? '<div class="mat-next-topic">‚ñ∂ Pr√≥ximo: <b>'+proximoTopico+'</b></div>' : '<div class="mat-next-topic" style="color:var(--green)">‚úì Ciclo completo!</div>')
        +'</div>';
    }

    var total    = lista.reduce(function(s,t){ return s+t.qty; }, 0);
    var qFeitas  = lista.slice(0, ptr).reduce(function(s,t){ return s+t.qty; }, 0);
    var qRestam  = total - qFeitas + totalAcum;
    var pct2     = total > 0 ? Math.min(100, Math.round((qFeitas/total)*100)) : 0;
    var hEstimado = qRestam > 0 ? (qRestam / qsHora) : 0;
    var hLabel = hEstimado >= 1 ? Math.round(hEstimado)+'h' : Math.round(hEstimado * 60)+'min';
    var proximoTopico2 = lista[ptr] ? lista[ptr] : null;
    var proxSize2 = proximoTopico2 ? (proximoTopico2.size === 'g' ? 'GRANDE' : proximoTopico2.size === 'm' ? 'M√âDIO' : 'PEQ') : null;
    var proxQs2   = proximoTopico2 ? proximoTopico2.qty : 0;

    return '<div class="mat-card">'
      +'<div class="mat-top">'
      +'<span class="mat-name" style="color:'+cor+'">'+label+'</span>'
      +(volta>1 ? '<span class="volta-chip">'+volta+'¬™ volta</span>' : '')
      +'</div>'
      +'<div style="display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-bottom:4px">'
      +'<span>'+ptr+'/'+lista.length+' t√≥picos</span>'
      +'<span style="color:'+cor+';font-weight:700">'+pct2+'%</span>'
      +'</div>'
      +'<div class="mini-bar"><div class="mini-fill" style="width:'+pct2+'%;background:'+cor+'"></div></div>'
      +'<div class="mat-stats-row">'
      +'<div class="mat-stat"><div class="mat-stat-val" style="color:'+cor+'">'+qFeitas+'</div><div class="mat-stat-lbl">Qs feitas</div></div>'
      +'<div class="mat-stat"><div class="mat-stat-val" style="color:var(--muted)">'+qRestam+'</div><div class="mat-stat-lbl">Restam</div></div>'
      +'<div class="mat-stat"><div class="mat-stat-val" style="color:var(--yellow)">'+(hEstimado > 0 ? hLabel : '‚Äî')+'</div><div class="mat-stat-lbl">p/ concluir</div></div>'
      +'</div>'
      +(totalAcum > 0 ? '<div class="mat-acum-row"><span style="font-size:10px;color:var(--yellow)">‚Ü∫ '+totalAcum+' quest√µes acumuladas para revisar</span></div>' : '')
      +(proximoTopico2 ? '<div class="mat-next-topic">‚ñ∂ Pr√≥ximo: <b>'+proximoTopico2.nome+'</b> <span style="color:var(--muted);font-size:9px">('+proxSize2+' ¬∑ '+proxQs2+'q)</span></div>' : '<div class="mat-next-topic" style="color:var(--green)">‚úì Ciclo completo!</div>')
      +(errosAtivos > 0 ? '<div class="mat-erros-row">üìì <span>'+errosAtivos+' erro'+(errosAtivos>1?'s':'')+' no caderno'+(errosPendentes>0 ? ' ¬∑ <span style="color:var(--orange)">'+errosPendentes+' p/ revisar hoje</span>':'')+'</span></div>' : '')
      +'</div>';
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REVIS√ïES NOS DIAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getRevisoesDoDia(ceData, date){
  var ds = dateStr(date);
  var result = [];
  ceData.forEach(function(entry){
    entry.steps.forEach(function(step, si){
      if(step.date === ds && !step.done){
        var dias = entry.intervalDias || REVISAO_DIAS;
        result.push({
          entryId: entry.id, stepIdx: si,
          mat: entry.mat, topico: entry.topico,
          stepLabel: (dias[si]||'?')+'d', ds: ds
        });
      }
    });
  });
  return result;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CADERNO DE ERROS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function adicionarErro(){
  var mat    = document.getElementById('ce-mat').value;
  var topico = document.getElementById('ce-topico').value.trim();
  var submat = document.getElementById('ce-submat') ? document.getElementById('ce-submat').value : '';
  var data   = document.getElementById('ce-data').value;
  if(!data){ alert('Selecione a data do erro.'); return; }
  var link = document.getElementById('ce-link').value.trim();
  var topicoFinal = submat || topico || '‚Äî';
  var baseDate = new Date(data+'T12:00:00');
  var intervalDias = REVISAO_DIAS.slice();
  var steps = intervalDias.map(function(d){
    var dt = new Date(baseDate);
    dt.setDate(dt.getDate() + d);
    return {date: dateStr(dt), done: false};
  });
  var entry = {id: Date.now(), mat: mat, topico: topicoFinal, link: link, dataErro: data, steps: steps, intervalDias: intervalDias};
  var ceData = loadData(SK_CE, []);
  ceData.push(entry);
  saveData(SK_CE, ceData);
  document.getElementById('ce-topico').value = '';
  if(document.getElementById('ce-submat')) document.getElementById('ce-submat').value = '';
  document.getElementById('ce-link').value = '';
  renderCaderno();
  updateCeBadge();
}

function makeTecLink(url){
  return '<a href="'+url+'" target="_blank" class="tec-inline-link">‚Üó TEC</a>';
}

function renderCaderno(){
  var ceData = loadData(SK_CE, []);
  var filterMatEl    = document.getElementById('filter-mat');
  var filterStatusEl = document.getElementById('filter-status');
  if(!filterMatEl || !filterStatusEl) return;

  var filterMat    = filterMatEl.value;
  var filterStatus = filterStatusEl.value;
  var today        = dateStr(new Date());

  var pendentes=0, atrasadas=0, concluidas=0;
  ceData.forEach(function(e){
    e.steps.forEach(function(s){
      if(s.done)              concluidas++;
      else if(s.date < today) atrasadas++;
      else                    pendentes++;
    });
  });

  var setEl = function(id, val){ var el = document.getElementById(id); if(el) el.textContent = val; };
  setEl('ce-total-reg', ceData.length);
  setEl('ce-pendentes', pendentes);
  setEl('ce-atrasadas', atrasadas);
  setEl('ce-concluidas', concluidas);

  updateCeBadge();
  renderAgenda(ceData);

  var filtered = ceData.slice();
  if(filterMat) filtered = filtered.filter(function(e){ return e.mat === filterMat; });
  if(filterStatus === 'pending')  filtered = filtered.filter(function(e){ return e.steps.some(function(s){ return !s.done && s.date >= today; }); });
  if(filterStatus === 'overdue')  filtered = filtered.filter(function(e){ return e.steps.some(function(s){ return !s.done && s.date < today; }); });
  if(filterStatus === 'done')     filtered = filtered.filter(function(e){ return e.steps.every(function(s){ return s.done; }); });

  var wrap = document.getElementById('err-table-wrap');
  if(!wrap) return;

  if(filtered.length === 0){
    wrap.innerHTML = '<div class="empty-ce"><div class="icon">üì≠</div><p>Nenhum registro encontrado.</p></div>';
    return;
  }

  var rows = filtered.map(function(e){
    var matColor = MAT_COLORS[e.mat] || 'var(--accent)';
    var dias = e.intervalDias || REVISAO_DIAS;
    var stepsHtml = e.steps.map(function(s, si){
      var cls = 'pending-dot';
      if(s.done)              cls = 'done-dot';
      else if(s.date < today)  cls = 'overdue-dot';
      else if(s.date === today) cls = 'due-dot';
      var label = (dias[si]||'?')+'d';
      return '<div class="step-dot '+cls+'" title="'+(s.done?'‚úì Feito':'Revis√£o '+s.date)+'" onclick="toggleStep('+e.id+','+si+')">'+(s.done?'‚úì':label)+'</div>';
    }).join('');
    var allDone = e.steps.every(function(s){ return s.done; });
    return '<tr>'
      +'<td style="max-width:200px;word-break:break-word">'
      +e.topico
      +(e.link ? makeTecLink(e.link) : '')
      +'</td>'
      +'<td><span class="mat-tag" style="color:'+matColor+';background:'+matColor+'18;border-color:'+matColor+'44">'+e.mat+'</span></td>'
      +'<td>'+fmtDateShort(new Date(e.dataErro+'T12:00:00'))+'</td>'
      +'<td><div class="step-dots">'+stepsHtml+'</div></td>'
      +'<td>'+(allDone ? '<span style="color:var(--green);font-size:11px">‚úì Conclu√≠do</span>' : '<span style="color:var(--muted);font-size:10px">Em andamento</span>')+'</td>'
      +'<td><button class="err-del" onclick="deletarErro('+e.id+')" title="Remover">‚úï</button></td>'
      +'</tr>';
  }).join('');

  wrap.innerHTML = '<table class="err-table">'
    +'<thead><tr><th>T√≥pico</th><th>Mat√©ria</th><th>Data erro</th><th>Revis√µes</th><th>Status</th><th></th></tr></thead>'
    +'<tbody>'+rows+'</tbody>'
    +'</table>';
}

function renderAgenda(ceData){
  var tl = document.getElementById('agenda-timeline');
  if(!tl) return;
  var today = dateStr(new Date());
  var todayDate = new Date();
  todayDate.setHours(12,0,0,0);
  var limite = new Date(todayDate);
  limite.setDate(limite.getDate() + 30);
  var limiteStr = dateStr(limite);

  var byDate = {};
  ceData.forEach(function(e){
    e.steps.forEach(function(s, si){
      if(s.date >= today && s.date <= limiteStr){
        if(!byDate[s.date]) byDate[s.date] = [];
        var dias = e.intervalDias || REVISAO_DIAS;
        byDate[s.date].push({entry:e, stepIdx:si, step:s, label:(dias[si]||'?')+'d'});
      }
    });
  });

  var atrasados = [];
  ceData.forEach(function(e){
    var dias = e.intervalDias || REVISAO_DIAS;
    e.steps.forEach(function(s, si){
      if(!s.done && s.date < today)
        atrasados.push({entry:e, stepIdx:si, step:s, label:(dias[si]||'?')+'d', overdue:true});
    });
  });

  if(Object.keys(byDate).length === 0 && atrasados.length === 0){
    tl.innerHTML = '<div class="rev-empty" style="padding:16px 0">Nenhuma revis√£o nos pr√≥ximos 30 dias.</div>';
    return;
  }

  var html = '';
  if(atrasados.length > 0){
    html += '<div class="agenda-day-row">'
      +'<div class="agenda-date is-past">‚ö† Atrasadas ('+atrasados.length+')</div>'
      +'<div class="agenda-chips">'+atrasados.map(function(r){ return chipHtml(r, true); }).join('')+'</div>'
      +'</div>';
  }
  Object.keys(byDate).sort().forEach(function(ds){
    var items = byDate[ds];
    var dt    = new Date(ds+'T12:00:00');
    var isToday2 = ds === today;
    html += '<div class="agenda-day-row">'
      +'<div class="agenda-date '+(isToday2?'is-today':'')+'">'+( isToday2 ? 'Hoje ‚Äî '+fmtDateShort(dt) : fmtDateShort(dt))+'</div>'
      +'<div class="agenda-chips">'+items.map(function(r){ return chipHtml(r, false); }).join('')+'</div>'
      +'</div>';
  });
  tl.innerHTML = html;
}

function chipHtml(r, overdue){
  var todayStr2 = dateStr(new Date());
  var isDone    = r.step.done;
  var cls = isDone ? 'done' : overdue ? 'overdue' : r.step.date===todayStr2 ? 'today-chip' : 'pending';
  var doneBtn = !isDone
    ? '<span class="chip-done-btn" onclick="event.stopPropagation();toggleStep('+r.entry.id+','+r.stepIdx+')">‚úì</span>' : '';
  return '<div class="agenda-chip '+cls+'">'
    +'<span class="chip-mat">'+r.entry.mat+'</span>'
    +'<span style="opacity:.7">¬∑'+r.label+'</span>'
    +(r.entry.topico !== '‚Äî' ? '<span style="opacity:.5;font-size:9px">'+r.entry.topico.slice(0,18)+'</span>' : '')
    +doneBtn
    +'</div>';
}

function toggleStep(entryId, stepIdx){
  var ceData = loadData(SK_CE, []);
  var e = ceData.find(function(x){ return x.id === entryId; });
  if(!e) return;
  e.steps[stepIdx].done = !e.steps[stepIdx].done;
  saveData(SK_CE, ceData);
  renderCaderno();
  updateCeBadge();
}

function deletarErro(entryId){
  if(!confirm('Remover este registro?')) return;
  var ceData = loadData(SK_CE, []);
  ceData = ceData.filter(function(x){ return x.id !== entryId; });
  saveData(SK_CE, ceData);
  renderCaderno();
  updateCeBadge();
}

function updateCeBadge(){
  var ceData = loadData(SK_CE, []);
  var today  = dateStr(new Date());
  var due    = ceData.reduce(function(n,e){ return n + e.steps.filter(function(s){ return !s.done && s.date <= today; }).length; }, 0);
  ['ce-badge','ce-badge2'].forEach(function(id){
    var badge = document.getElementById(id);
    if(!badge) return;
    if(due > 0){ badge.style.display = 'inline-flex'; badge.textContent = due; }
    else badge.style.display = 'none';
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATE UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fmtDateCard(d){
  var dias  = ['dom','seg','ter','qua','qui','sex','s√°b'];
  var meses = ['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];
  return dias[d.getDay()]+' ¬∑ '+d.getDate()+' '+meses[d.getMonth()];
}
function dateStr(d){ return d.toISOString().split('T')[0]; }
function fmtDate(d){ return d.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric'}); }
function fmtDateShort(d){ return d.toLocaleDateString('pt-BR',{day:'2-digit',month:'short'}); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RESET / MODAIS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function confirmarReset(){ document.getElementById('modal-reset').style.display = 'flex'; }
function fecharModal(){     document.getElementById('modal-reset').style.display = 'none'; }
function executarReset(){
  fecharModal();
  saveData(SK_PLAN, buildFreshPlan());
  window._dayData = {};
  var pp    = document.getElementById('progress-panel');
  var pills = document.getElementById('pills');
  if(pp)    pp.style.display    = 'none';
  if(pills) pills.style.display = 'none';
  document.getElementById('plano-output').innerHTML = '<div style="text-align:center;padding:60px;color:var(--muted)">'
    +'<div style="font-size:36px;margin-bottom:12px">üîÑ</div>'
    +'<p>Progresso zerado. Clique em <b style="color:var(--text)">Gerar Plano</b>.</p>'
    +'</div>';
}
function abrirAjuda(){
  var m = document.getElementById('modal-ajuda');
  if(m) m.style.display = 'flex';
}
function fecharAjuda(){
  var m = document.getElementById('modal-ajuda');
  if(m) m.style.display = 'none';
}
function fecharAjudaFora(e){
  if(e.target === document.getElementById('modal-ajuda')) fecharAjuda();
}
function showSection(id){
  document.querySelectorAll('.ajuda-section').forEach(function(s){ s.classList.remove('active'); });
  document.querySelectorAll('.ajuda-nav-item').forEach(function(b){ b.classList.remove('active'); });
  var sec = document.getElementById(id);
  if(sec) sec.classList.add('active');
  document.querySelectorAll('.ajuda-nav-item').forEach(function(b){
    var oc = b.getAttribute('onclick') || '';
    if(oc.indexOf("'"+id+"'") !== -1) b.classList.add('active');
  });
}
function deepClone(o){
  try{ return JSON.parse(JSON.stringify(o)); }
  catch(e){ return {}; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.onload = function(){
  var today = new Date();
  document.getElementById('data-inicio').value = dateStr(today);
  document.getElementById('ce-data').value     = dateStr(today);

  var saved = loadData(SK_SETTINGS, null);
  if(saved){
    if(saved.dataInicio) document.getElementById('data-inicio').value     = saved.dataInicio;
    if(saved.duracao)    document.getElementById('duracao-meses').value   = saved.duracao;
    if(saved.qph){
      document.getElementById('qph').value           = saved.qph;
      document.getElementById('qph-val').textContent = saved.qph;
    }
    if(saved.nivel) document.getElementById('nivel').value = saved.nivel;
    buildDayHoursGrid(saved.dayHours);
    if(saved.preset) setPreset(saved.preset);
  } else {
    buildDayHoursGrid(null);
  }

  updateSubMat();

  var planState = loadData(SK_PLAN, null);
  if(planState && planState.pointers && Object.keys(planState.pointers).length > 0){
    gerarPlano();
  }
  updateCeBadge();
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONCLUIR DIA ‚Äî FIXED
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function concluirDia(cardStr){
  var saved = loadData(SK_PLAN, buildFreshPlan());
  if(!saved.diasFeitos) saved.diasFeitos = {};

  // Mark day as done
  saved.diasFeitos[cardStr] = true;

  // The _dayData snap already has the state AFTER this day's sessions were applied
  // (because in gerarPlano, we save the snap post-mutation for future days)
  var d = window._dayData && window._dayData[cardStr];
  if(d){
    // Use the post-session snapshot as the new saved progress
    saved.pointers = deepClone(d.snap.pointers);
    saved.voltas   = deepClone(d.snap.voltas);
    saved.acumulo  = deepClone(d.snap.acumulo);
  }

  saveData(SK_PLAN, saved);

  // Update UI
  var card = document.getElementById('card-'+cardStr);
  if(card){
    card.classList.add('done-card');
    var body = document.getElementById('dayb-'+cardStr);
    if(body){
      var footer = body.querySelector('.day-footer');
      if(footer){
        footer.innerHTML = '<div class="done-banner">‚úÖ Dia conclu√≠do</div>'
          +'<button class="btn-desfazer" onclick="desfazerDia(\''+cardStr+'\')">‚Ü© Desfazer</button>';
      }
    }
  }

  // Regenerate plan to reflect updated state
  gerarPlano();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DESFAZER DIA ‚Äî FIXED: rebuild state by replaying completed days
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function desfazerDia(cardStr){
  if(!confirm('Desfazer conclus√£o deste dia?')) return;

  var saved = loadData(SK_PLAN, buildFreshPlan());
  if(!saved.diasFeitos) return;

  // Remove this day from done list
  delete saved.diasFeitos[cardStr];

  // Rebuild state from scratch by replaying remaining done days in order
  var remainingDone = Object.keys(saved.diasFeitos).sort();

  var freshState = { pointers:{}, voltas:{}, acumulo:{} };

  var settings = getSettings();
  var qsHora = Math.max(1, parseInt(settings.qph));

  remainingDone.forEach(function(ds){
    // Reconstruct day params from SEMANA_BASE
    var dt = new Date(ds+'T12:00:00');
    var jsDay = dt.getDay();
    var baseIdx = jsDay === 0 ? 6 : jsDay - 1;
    var diaBase = SEMANA_BASE[baseIdx];
    var sliderEl = document.getElementById('dh-range-'+baseIdx);
    var totalH = sliderEl ? parseFloat(sliderEl.value) : (DEFAULT_HOURS[DIAS_SEMANA[baseIdx]] || 5);
    if(totalH === 0) return; // folga

    var ceData = loadData(SK_CE, []);
    var revisoesDoDia = getRevisoesDoDia(ceData, dt);
    var revMin = revisoesDoDia.length > 0 ? 35 : 0;
    var horasEstudo = Math.max(0, totalH - (revMin/60));

    var manha = diaBase.manha;
    var noite  = diaBase.noite;
    var totalPct = manha.pct + (noite.pct || 0) + (noite.pct2 || 0);
    var manhaH  = horasEstudo * manha.pct / totalPct;
    var noiteH  = horasEstudo * (noite.pct || 0) / totalPct;
    var noite2H = noite.pct2 ? horasEstudo * noite.pct2 / totalPct : 0;

    applySessionsToState(manha, noite, manhaH, noiteH, noite2H, qsHora, freshState);
  });

  saved.pointers = freshState.pointers;
  saved.voltas   = freshState.voltas;
  saved.acumulo  = freshState.acumulo;

  saveData(SK_PLAN, saved);
  gerarPlano();
}
</script>
</body>
</html>
Wed Feb 18 04:37:59 UTC 2026